<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ads Generator — Gerador de Anúncios Multi-Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --indigo-600:#4f46e5; --indigo-700:#4338ca; --bg:#f3f4f6; --card:#ffffff; }
    body { font-family:'Inter',sans-serif; background:var(--bg); }
    .card { background:var(--card); border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:.45rem .7rem; border-radius:.5rem; background:white; color:#374151; border:1px solid #e5e7eb; }
    .btn:hover{ background:#f9fafb; }
    .icon { width:18px; height:18px; stroke:#4b5563; fill:none; }
    .icon-fill { width:18px; height:18px; stroke:#4b5563; fill:#4b5563; }
    .loader { width:22px; height:22px; border-radius:9999px; border:3px solid #e5e7eb; border-top-color:#6b7280; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal { position:fixed; inset:0; background:rgba(15,23,42,.28); display:none; align-items:center; justify-content:center; padding:1.25rem; z-index:50; }
    .modal.open { display:flex; }
    .modal-card { width:100%; max-width:44rem; }
    .muted { color:#6b7280 }
    .badge { padding:.125rem .5rem; font-size:.75rem; border:1px solid #e5e7eb; border-radius:9999px; }
    .subctrl { display:flex; align-items:center; gap:.5rem; font-size:.8rem; color:#4b5563; }
    .pulse { animation: pulse 1s ease-in-out infinite; }
    @keyframes pulse { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
    .toolbar { display:flex; align-items:center; gap:.5rem; }
    .toolbar .grow { flex:1 1 auto; }
    .floating-right { margin-left:auto; display:flex; gap:.5rem; }
    .label-row { display:flex; align-items:center; justify-content:space-between; }
    .floating-tts { position:fixed; top:1rem; left:50%; transform:translateX(-50%); background:white; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.1); padding:1rem; z-index:40; display:none; max-width:90vw; }
    .floating-tts.show { display:block; animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity:0; transform:translateX(-50%) translateY(-20px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }
    .floating-tts .controls { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .floating-tts .label { font-size:.75rem; font-weight:600; color:#6b7280; margin-right:.5rem; }
    .tts-active { background:#4f46e5 !important; color:white !important; }
    .tts-active svg { stroke:white !important; }
    .tts-highlight { background:#dbeafe; color:#1e40af; font-weight:600; border-radius:.25rem; padding:0 .125rem; transition:all .1s; }
    .mono { font-family:monospace; }
    .cfg-nav-btn.active { background:#4f46e5; color:white; }
    .cfg-nav-btn.active svg { stroke:white; }
    .price-tab-btn.active { color:#4f46e5; border-bottom-color:#4f46e5; }
    .price-tab-content { display: none; }
    .price-tab-content.active { display: block; }
  </style>
</head>
<body class="min-h-screen">
  <main class="w-full max-w-5xl mx-auto p-4 grid gap-6">
    <section class="card p-5">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-2xl font-semibold text-gray-900">Ads Generator — Gerador de Anúncios Multi-Marketplace</h1>
          <p class="text-sm text-gray-600 mt-1">Python • FastAPI • OpenAI/Gemini</p>
        </div>
        <div class="flex gap-2">
          <button id="btnConfig" class="btn" title="Configurar">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8zm8 4a8 8 0 01-.32 2.24l2.06 1.6-2 3.46-2.45-1a8.06 8.06 0 01-1.93 1.12l-.37 2.62h-4l-.37-2.62A8.06 8.06 0 017.7 20.3l-2.45 1-2-3.46 2.06-1.6A7.93 7.93 0 015 12a7.93 7.93 0 01.32-2.24L3.26 8.16l2-3.46 2.45 1A8.06 8.06 0 019.64 4.6L10 2h4l.37 2.62a8.06 8.06 0 011.93 1.12l2.45-1 2 3.46-2.06 1.6A8 8 0 0120 12z" stroke-width="1.5"/></svg>
          </button>
        </div>
      </div>

      <div class="mt-4 grid sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-700 font-medium">Origem de dados</label>
          <select id="tinyInstance" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" disabled>
            <option value="">Nenhuma instância Tiny cadastrada</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-700 font-medium">SKU (Tiny)</label>
          <input id="tinySKU" type="text" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Digite o SKU do Tiny" disabled>
        </div>
      </div>

      <div class="mt-4 grid sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-700 font-medium">Produto</label>
          <input id="productName" type="text" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex.: Tapete higiênico 80x60 lavanda">
        </div>
        <div>
          <label class="text-sm text-gray-700 font-medium">Marketplace</label>
          <select id="marketplace" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="mercadolivre">Mercado Livre</option>
            <option value="shopee">Shopee</option>
            <option value="amazon">Amazon</option>
            <option value="magalu">Magalu</option>
            <option value="shein">Shein</option>
          </select>
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-gray-700 font-medium">LLM</label>
          <select id="llm" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="openai">OpenAI</option>
            <option value="gemini">Google Gemini</option>
          </select>
        </div>
      </div>

      <!-- Upload de arquivos -->
      <div class="mt-4">
        <label class="text-sm text-gray-700 font-medium">Arquivos de referência (opcional)</label>
        <p class="text-xs text-gray-500 mt-1">Imagens e arquivos de texto para gerar anúncios baseados em dados reais do produto (máx. 5MB por arquivo)</p>
        <div class="mt-2">
          <input 
            type="file" 
            id="fileInput" 
            multiple 
            accept="image/*,.txt"
            class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
          />
        </div>
        
        <!-- Tabela de arquivos carregados -->
        <div id="filesTable" class="mt-3 hidden">
          <!-- Avisos Gerais -->
          <div id="fileWarnings" class="mb-3 hidden"></div>
          
          <div class="rounded-md border border-gray-200 overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th class="px-3 py-2 text-left font-medium text-gray-700 w-8">#</th>
                  <th class="px-3 py-2 text-left font-medium text-gray-700">Arquivo</th>
                  <th class="px-3 py-2 text-left font-medium text-gray-700">Status</th>
                  <th class="px-3 py-2 text-center font-medium text-gray-700 w-20">Usar</th>
                  <th class="px-3 py-2 text-center font-medium text-gray-700 w-16"></th>
                </tr>
              </thead>
              <tbody id="filesTableBody" class="divide-y divide-gray-200">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Botão Gerar -->
      <div class="mt-4">
        <button id="btnGenerate" class="px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700 w-full"><span class="mr-2">⚡</span>Gerar conteúdo</button>
      </div>

      <div id="statusArea" class="mt-4 hidden">
        <div class="flex items-center gap-3 text-sm text-gray-700">
          <div class="loader" id="loader" aria-hidden="true"></div>
          <span id="statusText">Gerando…</span>
        </div>
      </div>

      <div id="demoWarn" class="mt-4 hidden">
        <div class="rounded-md border border-yellow-200 bg-yellow-50 p-3 text-sm text-yellow-800" id="demoText"></div>
      </div>
    </section>

    <!-- Leitor (TTS) -->
    <section class="card p-5" id="ttsSection">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Leitura em voz alta</h2>
        <div class="flex items-center gap-2" id="ttsControls">
          <button id="ttsPlay" class="btn" title="Play"><svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" stroke-width="1.5"/></svg></button>
          <button id="ttsPrev" class="btn" title="Anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M11 6l-7 6 7 6V6zM20 5v14" stroke-width="1.5"/></svg></button>
          <button id="ttsNext" class="btn" title="Próximo"><svg class="icon" viewBox="0 0 24 24"><path d="M13 6l7 6-7 6V6zM4 5v14" stroke-width="1.5"/></svg></button>
          <button id="ttsPause" class="btn" title="Pausar"><svg class="icon" viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z" stroke-width="1.5"/></svg></button>
          <button id="ttsStop" class="btn" title="Parar"><svg class="icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z" stroke-width="1.5"/></svg></button>
          <button id="ttsRate" class="btn" title="Velocidade">1x</button>
        </div>
      </div>
      <p class="text-sm text-gray-600 mt-2">Ordem: <b>Título</b> → <b>Descrição</b> → <b>FAQ (aprovada)</b> → <b>Cards</b>. <span class="badge muted" id="ttsAuto">Autoplay ON</span></p>
      <div id="ttsNow" class="text-sm text-gray-700 mt-2"></div>
    </section>

    <section class="card p-5" id="resultCard">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Resultado</h2>
        <div class="flex gap-2">
          <button id="copyAll" class="btn" title="Copiar tudo"><svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg></button>
        </div>
      </div>

      <!-- Título -->
      <div class="mt-4">
        <div class="label-row">
          <h3 class="font-medium text-gray-700 mt-1">Título</h3>
          <div class="toolbar">
            <div class="grow"></div>
            <button id="titlePrev" class="btn hidden" title="Versão anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
            <span id="titleCount" class="muted hidden">1/1</span>
            <button id="titleNext" class="btn hidden" title="Próxima versão"><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
            <button id="regenTitle" class="btn" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
            <button id="regenTitlePrompt" class="btn" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
            <button id="copyTitle" class="btn" title="Copiar título"><svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg></button>
          </div>
        </div>
        <textarea id="outTitle" rows="2" class="mt-2 w-full mono rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"></textarea>
      </div>

      <!-- Descrição -->
      <div class="mt-6">
        <div class="label-row">
          <h3 class="font-medium text-gray-700 mt-1">Descrição</h3>
        </div>
        <div class="toolbar mt-1">
          <div class="grow"></div>
          <button id="descPrev" class="btn hidden" title="Versão anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
          <span id="descCount" class="muted hidden">1/1</span>
          <button id="descNext" class="btn hidden" title="Próxima versão"><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
          <button id="regenDesc" class="btn" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
          <button id="regenDescPrompt" class="btn" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
          <button id="copyDesc" class="btn" title="Copiar descrição (com FAQ)"><svg class="icon-fill" viewBox="0 0 24 24"><path d="M9 9h11v11H9z"/><path d="M4 4h11v11H4z"/></svg></button>
          <button id="copyDescNoFAQ" class="btn" title="Copiar descrição (sem FAQ)"><svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg></button>
        </div>
        <textarea id="outDesc" rows="10" class="mt-2 w-full mono rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"></textarea>
      </div>

      <!-- FAQ -->
      <div class="mt-6">
        <div class="label-row">
          <h3 class="font-medium text-gray-700">FAQ</h3>
          <div class="toolbar">
            <button id="copyFAQApproved" class="btn" title="Copiar FAQ aprovada"><svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg></button>
          </div>
        </div>
        <div id="faqList" class="mt-2 grid gap-2"></div>
      </div>

      <!-- Cards -->
      <div class="mt-6">
        <h3 class="font-medium text-gray-700">Cards</h3>
        <div id="cardsList" class="mt-2 grid gap-3"></div>
      </div>

      <!-- Informações cadastrais -->
      <div class="mt-6" id="tinyInfoSection">
        <h3 class="font-medium text-gray-700">Informações cadastrais</h3>
        <div class="grid sm:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm text-gray-600 font-medium">GTIN/EAN</label>
            <div class="flex gap-1 mt-1">
              <input id="tinyGTIN" type="text" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="7891234567890">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinyGTIN" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 font-medium">SKU</label>
            <div class="flex gap-1 mt-1">
              <input id="tinySKUDisplay" type="text" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="PROD-12345">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinySKUDisplay" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 font-medium">Altura (cm)</label>
            <div class="flex gap-1 mt-1">
              <input id="tinyHeight" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="25.0">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinyHeight" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 font-medium">Largura (cm)</label>
            <div class="flex gap-1 mt-1">
              <input id="tinyWidth" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="15.0">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinyWidth" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 font-medium">Comprimento (cm)</label>
            <div class="flex gap-1 mt-1">
              <input id="tinyLength" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="30.0">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinyLength" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 font-medium">Peso (kg)</label>
            <div class="flex gap-1 mt-1">
              <input id="tinyWeight" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="250.0">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinyWeight" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Informações de preço -->
      <div class="mt-6" id="tinyPriceSection">
        <h3 class="font-medium text-gray-700">Informações de preço</h3>
        
        <!-- Custos Base -->
        <div class="grid sm:grid-cols-2 gap-4 mt-3">
          <div>
            <label class="text-sm text-gray-600 font-medium">Custo base (R$)</label>
            <div class="flex gap-1 mt-1">
              <input id="tinyCostPrice" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="50.00">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinyCostPrice" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600 font-medium">Custo do frete (R$)</label>
            <div class="flex gap-1 mt-1">
              <input id="tinyShippingCost" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="0.00">
              <button class="btn text-xs copy-field-btn" data-copy-field="tinyShippingCost" title="Copiar conteúdo">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                <span class="ml-1">Copiar</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Botão Calcular Preços (apenas modo manual) -->
        <div id="manualPricingButton" class="mt-3" style="display: none;">
          <button id="calculatePricesBtn" class="btn w-full bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
            <svg class="icon w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Calcular Preços
          </button>
        </div>

        <!-- Tabs de Precificação -->
        <div class="mt-4">
          <div class="flex gap-2 border-b border-gray-200">
            <button class="price-tab-btn active px-4 py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600" data-tab="min">% Min (Clássico)</button>
            <button class="price-tab-btn px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800" data-tab="max">% Max (Premium)</button>
          </div>

          <!-- Tab Content: % Min -->
          <div class="price-tab-content active mt-4 mb-6" data-tab="min">
            <div class="grid sm:grid-cols-1 gap-4">
              <!-- Preço do Anúncio (calculado: promo / 0.85) -->
              <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                <label class="text-sm text-blue-800 font-semibold flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                  Preço do Anúncio (R$)
                  <span class="text-xs font-normal text-blue-600">(com 15% desconto = promo)</span>
                </label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyAnnouncePriceMin" type="number" step="0.01" class="flex-1 rounded-md border border-blue-300 bg-white px-3 py-2 text-sm font-semibold text-blue-900" placeholder="0.00" readonly>
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyAnnouncePriceMin" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 font-medium">Preço de lista (R$)</label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyListPriceMin" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="99.90" readonly>
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyListPriceMin" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-1">
                  <input type="text" class="analysis-margin rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0%" title="% de margem">
                  <input type="text" class="analysis-multiple rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0x" title="Múltiplo de valor">
                  <input type="text" class="analysis-value rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="R$ 0" title="Valor monetário">
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 font-medium">Preço agressivo (R$) <span class="text-xs text-gray-500">editável</span></label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyAggressivePriceMin" type="number" step="0.01" class="editable-price flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="79.90">
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyAggressivePriceMin" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-1">
                  <input type="text" class="analysis-margin rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0%" title="% de margem">
                  <input type="text" class="analysis-multiple rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0x" title="Múltiplo de valor">
                  <input type="text" class="analysis-value rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="R$ 0" title="Valor monetário">
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 font-medium">Preço promocional (R$) <span class="text-xs text-gray-500">editável</span></label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyPromoPriceMin" type="number" step="0.01" class="editable-price flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="89.90">
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyPromoPriceMin" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-1">
                  <input type="text" class="analysis-margin rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0%" title="% de margem">
                  <input type="text" class="analysis-multiple rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0x" title="Múltiplo de valor">
                  <input type="text" class="analysis-value rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="R$ 0" title="Valor monetário">
                </div>
              </div>
            </div>
            
            <!-- Tabela de Atacado (apenas na aba % Min) -->
            <div class="mt-4">
              <label class="text-sm text-gray-600 font-medium">Faixas de preço por atacado</label>
              <div class="mt-2 rounded-md border border-gray-200 overflow-hidden">
                <table class="w-full text-sm" id="wholesalePriceTable">
                  <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th class="px-3 py-2 text-left font-medium text-gray-700">Preço unitário (R$)</th>
                      <th class="px-3 py-2 text-left font-medium text-gray-700">Quantidade (#)</th>
                      <th class="px-3 py-2 text-left font-medium text-gray-700">% Margem</th>
                      <th class="px-3 py-2 text-left font-medium text-gray-700">Break-even</th>
                      <th class="px-3 py-2 text-center font-medium text-gray-700 w-20"></th>
                    </tr>
                  </thead>
                  <tbody id="wholesalePriceBody" class="divide-y divide-gray-200">
                    <!-- Linhas serão adicionadas dinamicamente -->
                  </tbody>
                </table>
              </div>
              <button id="addWholesaleRow" class="btn text-xs mt-2">+ Adicionar faixa</button>
            </div>
          </div>

          <!-- Tab Content: % Max -->
          <div class="price-tab-content mt-4 mb-6" data-tab="max">
            <div class="grid sm:grid-cols-1 gap-4">
              <!-- Preço do Anúncio (calculado: promo / 0.85) -->
              <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                <label class="text-sm text-blue-800 font-semibold flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                  Preço do Anúncio (R$)
                  <span class="text-xs font-normal text-blue-600">(com 15% desconto = promo)</span>
                </label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyAnnouncePriceMax" type="number" step="0.01" class="flex-1 rounded-md border border-blue-300 bg-white px-3 py-2 text-sm font-semibold text-blue-900" placeholder="0.00" readonly>
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyAnnouncePriceMax" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 font-medium">Preço de lista (R$)</label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyListPriceMax" type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="99.90" readonly>
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyListPriceMax" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-1">
                  <input type="text" class="analysis-margin rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0%" title="% de margem">
                  <input type="text" class="analysis-multiple rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0x" title="Múltiplo de valor">
                  <input type="text" class="analysis-value rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="R$ 0" title="Valor monetário">
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 font-medium">Preço agressivo (R$) <span class="text-xs text-gray-500">editável</span></label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyAggressivePriceMax" type="number" step="0.01" class="editable-price flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="79.90">
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyAggressivePriceMax" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-1">
                  <input type="text" class="analysis-margin rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0%" title="% de margem">
                  <input type="text" class="analysis-multiple rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0x" title="Múltiplo de valor">
                  <input type="text" class="analysis-value rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="R$ 0" title="Valor monetário">
                </div>
              </div>
              
              <div>
                <label class="text-sm text-gray-600 font-medium">Preço promocional (R$) <span class="text-xs text-gray-500">editável</span></label>
                <div class="flex gap-1 mt-1">
                  <input id="tinyPromoPriceMax" type="number" step="0.01" class="editable-price flex-1 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="89.90">
                  <button class="btn text-xs copy-field-btn" data-copy-field="tinyPromoPriceMax" title="Copiar conteúdo">
                    <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>
                    <span class="ml-1">Copiar</span>
                  </button>
                </div>
                <div class="grid grid-cols-3 gap-1 mt-1">
                  <input type="text" class="analysis-margin rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0%" title="% de margem">
                  <input type="text" class="analysis-multiple rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="0x" title="Múltiplo de valor">
                  <input type="text" class="analysis-value rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-700" readonly placeholder="R$ 0" title="Valor monetário">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <div class="pb-16"></div><!-- Margem inferior para evitar elementos "apertados" -->

  <!-- Controles TTS Flutuantes -->
  <div id="floatingTTS" class="floating-tts">
    <div class="controls">
      <span class="label">🔊 Leitura</span>
      <button id="ttsPlayFloat" class="btn" title="Play"><svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" stroke-width="1.5"/></svg></button>
      <button id="ttsPrevFloat" class="btn" title="Anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M11 6l-7 6 7 6V6zM20 5v14" stroke-width="1.5"/></svg></button>
      <button id="ttsNextFloat" class="btn" title="Próximo"><svg class="icon" viewBox="0 0 24 24"><path d="M13 6l7 6-7 6V6zM4 5v14" stroke-width="1.5"/></svg></button>
      <button id="ttsPauseFloat" class="btn" title="Pausar"><svg class="icon" viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z" stroke-width="1.5"/></svg></button>
      <button id="ttsStopFloat" class="btn" title="Parar"><svg class="icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z" stroke-width="1.5"/></svg></button>
      <button id="ttsRateFloat" class="btn" title="Velocidade">1x</button>
    </div>
  </div>

  <!-- Modal Prompt -->
  <div id="promptModal" class="modal">
    <div class="modal-card card p-5">
      <h3 id="promptTitle" class="text-lg font-semibold text-gray-800">Instruções adicionais</h3>
      <textarea id="promptText" rows="6" class="mt-2 w-full mono rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="Descreva o que ajustar, corrigir ou detalhar..."></textarea>
      <div class="mt-3 flex justify-end gap-2">
        <button id="promptCancel" class="btn">Cancelar</button>
        <button id="promptOk" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- Modal Config -->
  <div id="configModal" class="modal">
    <div class="modal-card card" style="max-width: 1100px; width: 95%; height: 85vh; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 flex-shrink-0">
        <h3 class="text-lg font-semibold text-gray-800">Configurações</h3>
        <button id="cfgClose" class="btn" title="Fechar">Fechar</button>
      </div>

      <!-- Body with Sidebar + Content -->
      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Menu -->
        <div class="w-48 bg-gray-50 border-r border-gray-200 overflow-y-auto">
          <nav class="p-2">
            <button class="cfg-nav-btn active w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors" data-section="llm">
              <svg class="inline-block w-4 h-4 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              LLM
            </button>
            <button class="cfg-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors" data-section="rulesets">
              <svg class="inline-block w-4 h-4 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              Rule Sets
            </button>
            <button class="cfg-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors" data-section="integrations">
              <svg class="inline-block w-4 h-4 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              Integrações
            </button>
            <button class="cfg-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-200 transition-colors" data-section="pricing">
              <svg class="inline-block w-4 h-4 mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              Precificação
            </button>
          </nav>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto">
          <!-- Section: LLM -->
          <div class="cfg-section active p-5" data-section="llm">
            <h4 class="text-md font-semibold text-gray-800 mb-4">Configuração de LLM</h4>
            
            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label class="text-sm text-gray-700 font-medium">OpenAI API Key</label>
                <input id="cfgOpenAI" type="password" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
              </div>
              <div>
                <label class="text-sm text-gray-700 font-medium">OpenAI Base URL (opcional)</label>
                <input id="cfgOpenAIBase" type="text" placeholder="https://api.openai.com/v1" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
              </div>
              <div>
                <label class="text-sm text-gray-700 font-medium">Gemini API Key</label>
                <input id="cfgGemini" type="password" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
              </div>
              <div>
                <label class="text-sm text-gray-700 font-medium">Gemini Base URL (opcional)</label>
                <input id="cfgGeminiBase" type="text" placeholder="https://generativelanguage.googleapis.com" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
              </div>
            </div>

            <div class="mt-4">
              <label class="text-sm text-gray-700 font-medium">Prompt Template</label>
              <textarea id="cfgPromptTpl" rows="18" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"
                placeholder='Use {product}, {marketplace} e {specs}. As demais chaves {{ }} do JSON podem ficar sem escape.'></textarea>
            </div>
          </div>

          <!-- Section: Rule Sets -->
          <div class="cfg-section p-5" data-section="rulesets" style="display: none;">
            <h4 class="text-md font-semibold text-gray-800 mb-4">Rule Sets</h4>
            <p class="text-sm text-gray-600 mb-3">Configure regras específicas por marketplace (formato JSON)</p>
            
            <textarea id="cfgRules" rows="25" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-mono" 
              placeholder='{"mercadolivre":{"title_max_chars":60}}'></textarea>
          </div>

          <!-- Section: Integrações -->
          <div class="cfg-section p-5" data-section="integrations" style="display: none;">
            <h4 class="text-md font-semibold text-gray-800 mb-4">Integrações</h4>
            
            <div class="border-b border-gray-200 pb-4 mb-4">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <label class="text-sm text-gray-700 font-medium">Tokens Tiny ERP</label>
                  <p class="text-xs text-gray-500 mt-1">Configure as instâncias do Tiny ERP para buscar dados de produtos</p>
                </div>
                <button id="cfgAddTiny" class="btn text-xs" title="Adicionar instância">+ Adicionar</button>
              </div>
              <div id="cfgTinyTokensList" class="grid gap-2">
                <p class="text-xs text-gray-500 italic">Nenhum token configurado</p>
              </div>
            </div>
          </div>

          <!-- Section: Precificação -->
          <div class="cfg-section p-5" data-section="pricing" style="display: none;">
            <h4 class="text-md font-semibold text-gray-800 mb-4">Dados de Precificação</h4>
            <p class="text-xs text-gray-500 mb-3">Configure os percentuais de comissão, impostos e margens para cada marketplace</p>
            
            <div class="mb-3">
              <button id="cfgAddPricing" class="btn text-xs" title="Adicionar marketplace">+ Adicionar Marketplace</button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full text-xs border border-gray-200 rounded-md">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-2 py-2 text-left font-medium text-gray-700">Marketplace</th>
                    <th class="px-2 py-2 text-center font-medium text-gray-700">% Min<br/><span class="font-normal text-gray-500">(Clássico)</span></th>
                    <th class="px-2 py-2 text-center font-medium text-gray-700">% Max<br/><span class="font-normal text-gray-500">(Premium)</span></th>
                    <th class="px-2 py-2 text-center font-medium text-gray-700">% TACOS<br/><span class="font-normal text-gray-500">(Publicidade)</span></th>
                    <th class="px-2 py-2 text-center font-medium text-gray-700">% M.C.<br/><span class="font-normal text-gray-500">(Margem)</span></th>
                    <th class="px-2 py-2 text-center font-medium text-gray-700">% Lucro</th>
                    <th class="px-2 py-2 text-center font-medium text-gray-700">% Impostos</th>
                    <th class="px-2 py-2 text-center font-medium text-gray-700 w-16">Ações</th>
                  </tr>
                </thead>
                <tbody id="cfgPricingTableBody">
                  <tr>
                    <td colspan="8" class="px-3 py-4 text-center text-gray-500 italic">Nenhuma configuração de preço cadastrada</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-2 px-5 py-4 border-t border-gray-200 bg-gray-50 flex-shrink-0">
        <button id="cfgCancel" class="btn">Cancelar</button>
        <button id="cfgSave" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    function $(q){ return document.querySelector(q); }
    const LS_KEY = "adsgen_settings_v2";
    const LS_STATE = "adsgen_state_v3";
    const LS_TTS_RATE = "adsgen_tts_rate";

    const productName = $("#productName"), marketplace=$("#marketplace"), llm=$("#llm");
    const btnGenerate=$("#btnGenerate");
    const outTitle=$("#outTitle"), outDesc=$("#outDesc");
    const faqList=$("#faqList"), cardsList=$("#cardsList");
    const statusArea=$("#statusArea"), statusText=$("#statusText"), loader=$("#loader");
    const demoWarn=$("#demoWarn"), demoText=$("#demoText");

    const titlePrev=$("#titlePrev"), titleNext=$("#titleNext"), titleCount=$("#titleCount");
    const descPrev=$("#descPrev"), descNext=$("#descNext"), descCount=$("#descCount");

    // File Upload Management
    const fileInput = $("#fileInput");
    const filesTable = $("#filesTable");
    const filesTableBody = $("#filesTableBody");
    const fileWarnings = $("#fileWarnings");
    let uploadedFiles = []; // Array para armazenar: {file: File, enabled: boolean, id: string, valid: boolean, error: string}

    // Limites de validação
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const MAX_FILES_PROCESSED = 10; // Apenas 10 primeiros serão processados
    const MAX_TOTAL_SIZE = 20 * 1024 * 1024; // 20MB total

    // Tipos de arquivo aceitos por LLM
    const LLM_FILE_TYPES = {
      openai: ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp', 'text/plain'],
      gemini: ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp', 'text/plain']
    };

    function updateFileAccept(){
      const selectedLLM = llm.value;
      fileInput.accept = 'image/*,.txt';
    }

    // Tiny ERP Integration
    const tinyInstance = $("#tinyInstance");
    const tinySKU = $("#tinySKU");
    const tinyInfoSection = $("#tinyInfoSection");
    const tinyPriceSection = $("#tinyPriceSection");
    
    // Campos de informações cadastrais
    const tinyGTIN = $("#tinyGTIN");
    const tinySKUDisplay = $("#tinySKUDisplay");
    const tinyHeight = $("#tinyHeight");
    const tinyWidth = $("#tinyWidth");
    const tinyLength = $("#tinyLength");
    const tinyWeight = $("#tinyWeight");
    
    // Campos de preço
    const tinyCostPrice = $("#tinyCostPrice");
    const tinyShippingCost = $("#tinyShippingCost");
    const wholesalePriceBody = $("#wholesalePriceBody");
    const addWholesaleRow = $("#addWholesaleRow");
    const manualPricingButton = $("#manualPricingButton");
    const calculatePricesBtn = $("#calculatePricesBtn");
    
    // Campos de preço % Min
    const tinyListPriceMin = $("#tinyListPriceMin");
    const tinyAggressivePriceMin = $("#tinyAggressivePriceMin");
    const tinyPromoPriceMin = $("#tinyPromoPriceMin");
    
    // Campos de preço % Max
    const tinyListPriceMax = $("#tinyListPriceMax");
    const tinyAggressivePriceMax = $("#tinyAggressivePriceMax");
    const tinyPromoPriceMax = $("#tinyPromoPriceMax");
    
    // Estado da integração
    let integrationMode = "manual"; // "manual" ou "tiny"
    let wholesaleRows = [];
    let pricingDataMin = null; // Dados de precificação % min
    let pricingDataMax = null; // Dados de precificação % max
    
    // Função auxiliar para feedback visual de cópia
    function showCopyFeedback(button, options = {}) {
      const { duration = 1500, showText = false } = options;
      
      // Preservar o estado original verdadeiro (primeira vez que o feedback é aplicado)
      if (!button.dataset.originalHtml) {
        button.dataset.originalHtml = button.innerHTML;
        button.dataset.originalClasses = button.className;
      }
      
      // Cancelar timeout anterior se existir
      if (button.dataset.timeoutId) {
        clearTimeout(parseInt(button.dataset.timeoutId));
      }
      
      // Ícone de checkmark com texto opcional
      const checkIcon = '<svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="2" fill="none"/></svg>';
      button.innerHTML = showText ? checkIcon + '<span class="ml-1">Copiado!</span>' : checkIcon;
      button.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
      
      // Agendar restauração do estado original
      const timeoutId = setTimeout(() => {
        button.innerHTML = button.dataset.originalHtml;
        button.className = button.dataset.originalClasses;
        // Limpar os dados armazenados
        delete button.dataset.originalHtml;
        delete button.dataset.originalClasses;
        delete button.dataset.timeoutId;
      }, duration);
      
      button.dataset.timeoutId = timeoutId.toString();
    }
    
    // Dados do produto Tiny (dados reais da API)
    let tinyProductData = null;
    let isFetchingTinyData = false;
    
    // Buscar dados do produto Tiny da API
    async function fetchTinyProductData(token, sku) {
      try {
        const response = await fetch('/api/tiny/product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, sku })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.detail?.message || `Erro HTTP ${response.status}`);
        }
        
        return result.data;
      } catch (error) {
        console.error('Erro ao buscar dados do Tiny:', error);
        throw error;
      }
    }
    
    // Atualizar estado da integração
    async function updateIntegrationMode() {
      const hasTinyTokens = getTinyTokens().length > 0;
      const selectedInstance = tinyInstance.value;
      const skuValue = tinySKU.value.trim();
      
      // Atualizar habilitação dos campos de origem
      tinyInstance.disabled = !hasTinyTokens;
      
      // Se não há tokens, limpar o SKU antes de desabilitar
      if (!hasTinyTokens) {
        tinySKU.value = "";
        tinyProductData = null;
      }
      
      tinySKU.disabled = !hasTinyTokens || !selectedInstance;
      
      // Determinar modo de integração
      const shouldBeTinyMode = hasTinyTokens && selectedInstance && skuValue;
      
      if (shouldBeTinyMode && !isFetchingTinyData) {
        integrationMode = "tiny";
        
        // Buscar dados do Tiny apenas se mudou o SKU ou não temos dados
        if (!tinyProductData || tinyProductData.sku !== skuValue) {
          isFetchingTinyData = true;
          
          // Armazenar SKU solicitado para validar após fetch
          const requestedSKU = skuValue;
          const requestedInstance = selectedInstance;
          
          // Mostrar loading visual
          tinySKU.classList.add('bg-blue-50', 'animate-pulse');
          
          try {
            const tokens = getTinyTokens();
            const instanceIndex = parseInt(requestedInstance);
            const selectedToken = tokens[instanceIndex]?.token;
            
            if (!selectedToken) {
              throw new Error('Token não encontrado para instância selecionada');
            }
            
            const fetchedData = await fetchTinyProductData(selectedToken, requestedSKU);
            
            // Validar se SKU/instância ainda são os mesmos após await
            const currentSKU = tinySKU.value.trim();
            const currentInstance = tinyInstance.value;
            
            if (currentSKU !== requestedSKU || currentInstance !== requestedInstance) {
              // SKU/instância mudou durante fetch - descartar dados e retriggerar
              console.log('SKU/instância mudou durante fetch - descartando dados');
              isFetchingTinyData = false;
              tinySKU.classList.remove('bg-blue-50', 'animate-pulse');
              // Retriggerar com novo SKU
              updateIntegrationMode();
              return;
            }
            
            // Dados são válidos - aplicar
            tinyProductData = fetchedData;
            
            // Feedback de sucesso
            tinySKU.classList.remove('bg-blue-50', 'animate-pulse');
            tinySKU.classList.add('bg-green-50');
            setTimeout(() => tinySKU.classList.remove('bg-green-50'), 1500);
            
          } catch (error) {
            console.error('Erro ao buscar produto Tiny:', error);
            tinyProductData = null;
            integrationMode = "manual";
            
            // Feedback de erro
            tinySKU.classList.remove('bg-blue-50', 'animate-pulse');
            tinySKU.classList.add('bg-red-50');
            setTimeout(() => tinySKU.classList.remove('bg-red-50'), 3000);
            
            // Mostrar mensagem de erro
            alert(`Erro ao buscar produto do Tiny: ${error.message}`);
            
            // Limpar UI no path de erro
            applyTinyState();
          } finally {
            isFetchingTinyData = false;
          }
        }
      } else {
        integrationMode = "manual";
        if (!shouldBeTinyMode) {
          tinyProductData = null;
        }
      }
      
      // Aplicar estado nos campos
      applyTinyState();
    }
    
    // Aplicar estado aos campos (habilitar/desabilitar e preencher com dados reais)
    function applyTinyState() {
      const isTinyMode = integrationMode === "tiny";
      
      if (isTinyMode && tinyProductData) {
        // Modo Tiny: preencher com dados REAIS da API e desabilitar
        productName.value = tinyProductData.title || "";
        tinyGTIN.value = tinyProductData.gtin || "";
        tinySKUDisplay.value = tinyProductData.sku || "";
        tinyHeight.value = tinyProductData.height_cm || "";
        tinyWidth.value = tinyProductData.width_cm || "";
        tinyLength.value = tinyProductData.length_cm || "";
        tinyWeight.value = tinyProductData.weight_kg || "";
        tinyCostPrice.value = tinyProductData.cost_price || "";
        
        // Desabilitar campos de cadastro
        [tinyGTIN, tinySKUDisplay, tinyHeight, tinyWidth, tinyLength, tinyWeight, tinyCostPrice].forEach(el => {
          el.disabled = true;
          el.classList.add('bg-gray-50');
        });
        
        // Limpar tabela de atacado (Tiny não retorna preços de atacado)
        wholesaleRows = [];
        renderWholesaleTable();
        addWholesaleRow.disabled = true;
        
        // Esconder botão de cálculo manual (modo Tiny calcula automaticamente)
        manualPricingButton.style.display = 'none';
        
        // Chamar auto-pricing após preencher dados do Tiny
        autoPricing();
        
      } else {
        // Modo Manual: LIMPAR valores e habilitar
        tinyGTIN.value = "";
        tinySKUDisplay.value = "";
        tinyHeight.value = "";
        tinyWidth.value = "";
        tinyLength.value = "";
        tinyWeight.value = "";
        tinyCostPrice.value = "";
        tinyShippingCost.value = "";
        
        [tinyGTIN, tinySKUDisplay, tinyHeight, tinyWidth, tinyLength, tinyWeight,
         tinyCostPrice, tinyShippingCost].forEach(el => {
          el.disabled = false;
          el.classList.remove('bg-gray-50');
        });
        
        // Limpar tabela de atacado
        wholesaleRows = [];
        renderWholesaleTable();
        addWholesaleRow.disabled = false;
        
        // Mostrar botão de cálculo manual e validar
        manualPricingButton.style.display = 'block';
        validateCalculateButton();
      }
    }
    
    // Renderizar tabela de preços de atacado
    function renderWholesaleTable() {
      wholesalePriceBody.innerHTML = '';
      const isTinyMode = integrationMode === "tiny";
      const totalCost = (parseFloat(tinyCostPrice.value) || 0) + (parseFloat(tinyShippingCost.value) || 0);
      
      wholesaleRows.forEach((row, idx) => {
        const margin = calculateMargin(row.price, totalCost);
        const breakEven = calculateBreakEven(row.price, totalCost);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">
            <div class="flex items-center gap-1">
              <input type="number" step="0.01" class="flex-1 rounded-md border border-gray-300 px-2 py-1 text-sm ${isTinyMode ? 'bg-gray-50' : 'bg-white'}" 
                     value="${row.price}" data-idx="${idx}" data-field="price" ${isTinyMode ? 'disabled' : ''}>
              <button class="copy-wholesale-btn btn-icon text-xs" data-copy-wholesale="${idx}" data-copy-wholesale-field="price" title="Copiar preço">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                  <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/>
                </svg>
              </button>
            </div>
          </td>
          <td class="px-3 py-2">
            <div class="flex items-center gap-1">
              <input type="number" class="flex-1 rounded-md border border-gray-300 px-2 py-1 text-sm ${isTinyMode ? 'bg-gray-50' : 'bg-white'}" 
                     value="${row.qty}" data-idx="${idx}" data-field="qty" ${isTinyMode ? 'disabled' : ''}>
              <button class="copy-wholesale-btn btn-icon text-xs" data-copy-wholesale="${idx}" data-copy-wholesale-field="qty" title="Copiar quantidade">
                <svg class="icon w-4 h-4" viewBox="0 0 24 24">
                  <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/>
                </svg>
              </button>
            </div>
          </td>
          <td class="px-3 py-2">
            <input type="text" class="w-full rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-600" 
                   value="${margin > 0 ? margin.toFixed(1) + '%' : '0%'}" readonly>
          </td>
          <td class="px-3 py-2">
            <input type="text" class="w-full rounded-md border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-center text-gray-600" 
                   value="${breakEven < 999 ? breakEven.toFixed(1) + 'x' : '∞'}" readonly>
          </td>
          <td class="px-3 py-2 text-center">
            <button class="btn text-xs" data-remove-row="${idx}" ${isTinyMode ? 'disabled' : ''} title="Remover">
              <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="1.5"/></svg>
            </button>
          </td>
        `;
        wholesalePriceBody.appendChild(tr);
      });
      
      // Event listeners para campos da tabela
      wholesalePriceBody.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          const value = parseFloat(e.target.value) || 0;
          wholesaleRows[idx][field] = value;
        });
      });
      
      // Event listeners para botões de remover
      wholesalePriceBody.querySelectorAll('[data-remove-row]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.dataset.removeRow);
          wholesaleRows.splice(idx, 1);
          renderWholesaleTable();
        });
      });
      
      // Event listeners para botões de copiar na tabela
      wholesalePriceBody.querySelectorAll('.copy-wholesale-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const idx = parseInt(btn.dataset.copyWholesale);
          const field = btn.dataset.copyWholesaleField;
          
          // Ler diretamente do input para pegar o valor atual (mesmo se não tiver dado blur)
          const input = wholesalePriceBody.querySelector(`input[data-idx="${idx}"][data-field="${field}"]`);
          const value = input ? input.value : '';
          
          if (value !== '') {
            navigator.clipboard.writeText(String(value)).then(() => {
              showCopyFeedback(btn);
            });
          }
        });
      });
    }
    
    // Adicionar nova linha à tabela de atacado
    addWholesaleRow.addEventListener('click', () => {
      wholesaleRows.push({ qty: 0, price: 0 });
      renderWholesaleTable();
    });
    
    // Event listeners para campos Tiny
    tinyInstance.addEventListener('change', updateIntegrationMode);
    tinySKU.addEventListener('input', updateIntegrationMode);
    
    // ============================================================================
    // NAVEGAÇÃO ENTRE ABAS DE PRECIFICAÇÃO
    // ============================================================================
    
    function switchPriceTab(tabName) {
      // Remover active de todos os botões e abas
      document.querySelectorAll('.price-tab-btn').forEach(btn => {
        btn.classList.remove('active', 'text-indigo-600', 'border-indigo-600');
        btn.classList.add('text-gray-600', 'border-transparent');
      });
      document.querySelectorAll('.price-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Ativar botão e aba selecionados
      const btn = document.querySelector(`.price-tab-btn[data-tab="${tabName}"]`);
      const content = document.querySelector(`.price-tab-content[data-tab="${tabName}"]`);
      
      if (btn) {
        btn.classList.add('active', 'text-indigo-600', 'border-indigo-600');
        btn.classList.remove('text-gray-600', 'border-transparent');
      }
      if (content) content.classList.add('active');
    }
    
    // Event listeners para navegação entre abas
    document.querySelectorAll('.price-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        switchPriceTab(tab);
      });
    });
    
    // ============================================================================
    // FUNÇÕES AUXILIARES DE CÁLCULO
    // ============================================================================
    
    // Calcula % de margem: (preço - custo_total) / preço * 100
    /**
     * Calcula análise financeira para um preço específico
     * @param {Object} params - Parâmetros de cálculo
     * @param {number} params.price - Preço do produto
     * @param {number} params.totalCost - Custo total (produto + frete)
     * @param {number} params.commissionPercent - % de comissão (decimal, ex: 0.12)
     * @param {Object} params.config - Configuração de precificação (tacos, margem_contribuicao, lucro, impostos)
     * @returns {Object} - {marginPct, valueMultiple, valueAmount}
     */
    function buildPriceAnalysis({ price, totalCost, commissionPercent, config }) {
      if (price <= 0) {
        return { marginPct: 0, valueMultiple: 0, valueAmount: 0 };
      }
      
      // Calcular todas as taxas variáveis (proporcionais ao preço)
      const impostos = price * config.impostos;
      const comissaoTotal = price * (commissionPercent + config.tacos + config.margem_contribuicao + config.lucro);
      
      // Valor monetário = o que sobra após todos os descontos
      const valueAmount = price - totalCost - impostos - comissaoTotal;
      
      // % de Margem = valor monetário / preço * 100
      const marginPct = (valueAmount / price) * 100;
      
      // Múltiplo = valor monetário / custo total
      const valueMultiple = totalCost > 0 ? valueAmount / totalCost : 0;
      
      return {
        marginPct: marginPct,
        valueMultiple: valueMultiple,
        valueAmount: valueAmount
      };
    }
    
    /**
     * Aplica análise de precificação para uma aba (min ou max)
     * @param {string} tabType - 'min' ou 'max'
     */
    function applyPriceAnalysisForTab(tabType) {
      const costPrice = parseFloat(tinyCostPrice.value) || 0;
      const shippingCost = parseFloat(tinyShippingCost.value) || 0;
      const totalCost = costPrice + shippingCost;
      
      // Guard: não calcular se não há custo definido
      if (totalCost <= 0) {
        console.warn('Custo total deve ser maior que zero para calcular análises');
        return;
      }
      
      // Obter configuração de precificação
      const channel = marketplace.value;
      const marketplaceConfig = getMarketplacePricingContext(channel);
      
      // Determinar qual % de comissão usar
      const commissionPercent = tabType === 'min' 
        ? marketplaceConfig.comissao_min / 100
        : marketplaceConfig.comissao_max / 100;
      
      // Configuração de taxas
      const config = {
        tacos: marketplaceConfig.tacos,
        margem_contribuicao: marketplaceConfig.margem_contribuicao,
        lucro: marketplaceConfig.lucro,
        impostos: marketplaceConfig.impostos
      };
      
      // Selecionar campos da aba correta
      const tabSuffix = tabType === 'min' ? 'Min' : 'Max';
      const announcePrice = document.getElementById(`tinyAnnouncePrice${tabSuffix}`);
      const listPrice = document.getElementById(`tinyListPrice${tabSuffix}`);
      const aggressivePrice = document.getElementById(`tinyAggressivePrice${tabSuffix}`);
      const promoPrice = document.getElementById(`tinyPromoPrice${tabSuffix}`);
      
      // 1. Calcular Preço do Anúncio (promo / 0.85)
      const promoPriceValue = parseFloat(promoPrice.value) || 0;
      if (promoPriceValue > 0) {
        announcePrice.value = (promoPriceValue / 0.85).toFixed(2);
      }
      
      // 2. Obter container da aba
      const tabContainer = document.querySelector(`.price-tab-content[data-tab="${tabType}"]`);
      if (!tabContainer) return;
      
      // 3. Calcular e preencher análises para cada preço
      const prices = [
        { input: listPrice, container: tabContainer.querySelectorAll('.grid')[1] },
        { input: aggressivePrice, container: tabContainer.querySelectorAll('.grid')[2] },
        { input: promoPrice, container: tabContainer.querySelectorAll('.grid')[3] }
      ];
      
      prices.forEach(({ input, container }) => {
        const price = parseFloat(input.value) || 0;
        const analysis = buildPriceAnalysis({ price, totalCost, commissionPercent, config });
        
        // Selecionar campos de análise
        const marginField = container.querySelector('.analysis-margin');
        const multipleField = container.querySelector('.analysis-multiple');
        const valueField = container.querySelector('.analysis-value');
        
        if (marginField && multipleField && valueField) {
          // Preencher valores
          marginField.value = `${analysis.marginPct.toFixed(1)}%`;
          multipleField.value = analysis.valueMultiple >= 0 && analysis.valueMultiple < 999 
            ? `${analysis.valueMultiple.toFixed(1)}x` 
            : (analysis.valueMultiple >= 999 ? '∞' : '-');
          valueField.value = `R$ ${analysis.valueAmount.toFixed(2)}`;
          
          // Aplicar estilos de destaque
          applyWarningStyles(marginField, analysis.marginPct < 0);
          applyWarningStyles(multipleField, analysis.valueMultiple < 30 && analysis.valueMultiple >= 0);
          applyWarningStyles(valueField, analysis.marginPct < 0);
        }
      });
    }
    
    /**
     * Aplica estilos de aviso (vermelho) quando necessário
     * @param {HTMLElement} field - Campo a ser estilizado
     * @param {boolean} isWarning - Se deve mostrar aviso
     */
    function applyWarningStyles(field, isWarning) {
      if (isWarning) {
        field.classList.add('bg-red-100', 'border-red-300', 'text-red-800', 'font-semibold');
        field.classList.remove('bg-gray-50', 'border-gray-200', 'text-gray-700');
      } else {
        field.classList.remove('bg-red-100', 'border-red-300', 'text-red-800', 'font-semibold');
        field.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-700');
      }
    }
    
    // ============================================================================
    // AUTO-PRICING: Calcula preços automaticamente via endpoint /pricing/quote
    // ============================================================================
    
    let autoPricingInProgress = false;
    
    async function autoPricing() {
      // Verificar se deve executar auto-pricing
      const costPrice = parseFloat(tinyCostPrice.value);
      const shippingCost = parseFloat(tinyShippingCost.value) || 0;
      const channel = marketplace.value;
      
      if (!costPrice || costPrice <= 0 || !channel) {
        return; // Não há dados suficientes para calcular
      }
      
      // Evitar chamadas concorrentes
      if (autoPricingInProgress) {
        return;
      }
      
      try {
        autoPricingInProgress = true;
        const totalCost = costPrice + shippingCost;
        
        // Obter dados de precificação do marketplace selecionado
        const pricingConfigAll = getPricingConfig();
        const marketplaceConfig = pricingConfigAll.find(c => c.marketplace === channel);
        
        if (!marketplaceConfig) {
          console.warn('Nenhuma configuração de precificação encontrada para', channel);
          return;
        }
        
        // Preparar contexto com parâmetros de precificação (exceto comissão)
        const pricingContext = {
          tacos: marketplaceConfig.tacos / 100,
          margem_contribuicao: marketplaceConfig.margem_contribuicao / 100,
          lucro: marketplaceConfig.lucro / 100,
          impostos: marketplaceConfig.impostos / 100
        };
        
        // Calcular preços para % MIN (Clássico) - passar commission_percent diretamente
        const responseMin = await fetch('/pricing/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cost_price: costPrice,
            shipping_cost: shippingCost,
            channel: channel,
            commission_percent: marketplaceConfig.comissao_min / 100,
            ctx: pricingContext
          })
        });
        
        if (!responseMin.ok) {
          console.error('Erro ao calcular preços MIN');
          return;
        }
        
        const dataMin = await responseMin.json();
        
        // Calcular preços para % MAX (Premium) - passar commission_percent diretamente
        const responseMax = await fetch('/pricing/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cost_price: costPrice,
            shipping_cost: shippingCost,
            channel: channel,
            commission_percent: marketplaceConfig.comissao_max / 100,
            ctx: pricingContext
          })
        });
        
        if (!responseMax.ok) {
          console.error('Erro ao calcular preços MAX');
          return;
        }
        
        const dataMax = await responseMax.json();
        
        // Preencher campos de preço calculados (funciona em qualquer modo)
        // Preencher % MIN
        tinyListPriceMin.value = dataMin.listing_price.toFixed(2);
        tinyAggressivePriceMin.value = dataMin.aggressive_price.toFixed(2);
        tinyPromoPriceMin.value = dataMin.promo_price.toFixed(2);
        
        // Preencher % MAX
        tinyListPriceMax.value = dataMax.listing_price.toFixed(2);
        tinyAggressivePriceMax.value = dataMax.aggressive_price.toFixed(2);
        tinyPromoPriceMax.value = dataMax.promo_price.toFixed(2);
        
        // Aplicar análises financeiras para ambas as abas
        applyPriceAnalysisForTab('min');
        applyPriceAnalysisForTab('max');
        
        // Preencher tabela de atacado (apenas % MIN)
        wholesaleRows = dataMin.wholesale_tiers.map(tier => ({
          price: tier.price,
          qty: tier.min_quantity,
          totalCost: totalCost
        }));
        renderWholesaleTable();
          
        // Feedback visual sutil
        [tinyListPriceMin, tinyAggressivePriceMin, tinyPromoPriceMin,
         tinyListPriceMax, tinyAggressivePriceMax, tinyPromoPriceMax].forEach(field => {
          field.classList.add('bg-green-50');
          setTimeout(() => field.classList.remove('bg-green-50'), 1000);
        });
        
        // Validação especial para Mercado Livre
        if (channel === 'mercadolivre' && !shippingCost && tinyPromoPriceMin.value) {
          const promoPrice = parseFloat(tinyPromoPriceMin.value);
          if (promoPrice > 78.99) {
            alert('⚠️ Atenção: O preço promocional calculado é maior que R$ 78,99.\n\nPara produtos do Mercado Livre nesta faixa de preço, é importante preencher o custo do frete para obter cálculos mais precisos.');
          }
        }
        
      } catch (error) {
        console.error('Erro ao buscar auto-pricing:', error);
      } finally {
        autoPricingInProgress = false;
      }
    }
    
    // Validar e habilitar/desabilitar botão de calcular preços
    function validateCalculateButton() {
      const costPrice = parseFloat(tinyCostPrice.value);
      const isValid = costPrice && costPrice > 0;
      calculatePricesBtn.disabled = !isValid;
    }
    
    // Listeners para validação do botão (modo manual)
    tinyCostPrice.addEventListener('input', () => {
      if (integrationMode === "manual") {
        validateCalculateButton();
      }
    });
    
    // Listeners para auto-pricing (APENAS modo Tiny)
    tinyCostPrice.addEventListener('change', () => {
      if (integrationMode === "tiny") {
        autoPricing();
      }
    });
    
    tinyShippingCost.addEventListener('change', () => {
      if (integrationMode === "tiny") {
        autoPricing();
      }
    });
    
    marketplace.addEventListener('change', () => {
      if (integrationMode === "tiny") {
        autoPricing();
      }
    });
    
    // Listener do botão calcular preços (modo manual)
    calculatePricesBtn.addEventListener('click', () => {
      autoPricing();
    });
    
    // Listeners para edição manual de preços → recalcular análises
    const editablePricesMin = [tinyAggressivePriceMin, tinyPromoPriceMin];
    const editablePricesMax = [tinyAggressivePriceMax, tinyPromoPriceMax];
    
    editablePricesMin.forEach(field => {
      field.addEventListener('input', () => {
        applyPriceAnalysisForTab('min');
      });
    });
    
    editablePricesMax.forEach(field => {
      field.addEventListener('input', () => {
        applyPriceAnalysisForTab('max');
      });
    });
    
    // Botões de copiar conteúdo
    document.addEventListener('click', (e) => {
      const copyBtn = e.target.closest('.copy-field-btn');
      if (copyBtn) {
        const fieldId = copyBtn.dataset.copyField;
        const field = $(`#${fieldId}`);
        if (field && field.value) {
          navigator.clipboard.writeText(field.value).then(() => {
            showCopyFeedback(copyBtn, { showText: true });
          });
        }
      }
    });

    // Validar um arquivo individualmente
    function validateFile(file) {
      const selectedLLM = llm.value;
      const allowedTypes = LLM_FILE_TYPES[selectedLLM] || [];
      const fileType = file.type || '';
      
      // Validar tipo
      if (!allowedTypes.includes(fileType)) {
        return { valid: false, error: `Tipo não suportado (${fileType})` };
      }
      
      // Validar tamanho
      if (file.size > MAX_FILE_SIZE) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(1);
        return { valid: false, error: `Arquivo muito grande (${sizeMB}MB, máx. 5MB)` };
      }
      
      return { valid: true, error: null };
    }

    // Atualizar avisos gerais
    function updateFileWarnings() {
      const warnings = [];
      const totalFiles = uploadedFiles.length;
      const validFiles = uploadedFiles.filter(f => f.valid).length;
      const enabledFiles = uploadedFiles.filter(f => f.valid && f.enabled).length;
      
      if (totalFiles > MAX_FILES_PROCESSED) {
        warnings.push(`⚠️ ${totalFiles} arquivos enviados. Apenas os <strong>10 primeiros válidos</strong> serão processados.`);
      }
      
      const totalSize = uploadedFiles.reduce((sum, f) => sum + (f.valid ? f.file.size : 0), 0);
      if (totalSize > MAX_TOTAL_SIZE) {
        warnings.push(`❌ Tamanho total excede 20MB. Alguns arquivos podem ser ignorados.`);
      }
      
      if (validFiles > 0) {
        warnings.push(`✓ <strong>${enabledFiles} de ${validFiles}</strong> arquivo(s) válido(s) será(ão) usado(s) na geração.`);
      }
      
      if (warnings.length > 0) {
        fileWarnings.innerHTML = warnings.map(w => 
          `<div class="rounded-md border ${w.startsWith('❌') ? 'border-red-200 bg-red-50 text-red-800' : w.startsWith('⚠️') ? 'border-yellow-200 bg-yellow-50 text-yellow-800' : 'border-blue-200 bg-blue-50 text-blue-800'} p-2 text-xs">${w}</div>`
        ).join('');
        fileWarnings.classList.remove('hidden');
      } else {
        fileWarnings.classList.add('hidden');
      }
    }

    function renderFilesTable(){
      if(uploadedFiles.length === 0){
        filesTable.classList.add('hidden');
        filesTableBody.innerHTML = '';
        fileWarnings.classList.add('hidden');
        return;
      }
      
      filesTable.classList.remove('hidden');
      filesTableBody.innerHTML = '';
      
      // PASSO 1: Inicializar enabled para novos arquivos
      uploadedFiles.forEach(item => {
        if (item.enabled === undefined || item.enabled === null) {
          item.enabled = true;
        }
        if (!item.valid) {
          item.enabled = false;
        }
      });
      
      // PASSO 2: Construir lista de arquivos que SERÃO PROCESSADOS (máximo 10)
      // Apenas arquivos válidos E marcados, na ordem, limitado a 10
      const processedFiles = [];
      for (const item of uploadedFiles) {
        if (item.valid && item.enabled && processedFiles.length < MAX_FILES_PROCESSED) {
          processedFiles.push(item);
        }
      }
      
      // PASSO 3: Se temos mais de 10 arquivos válidos marcados, desmarcar os que não entraram
      let validMarkedCount = 0;
      uploadedFiles.forEach(item => {
        if (item.valid && item.enabled) {
          validMarkedCount++;
          // Se este arquivo está marcado mas não entrou nos processedFiles, desmarcar
          if (!processedFiles.includes(item)) {
            item.enabled = false;
          }
        }
      });
      
      // PASSO 4: Calcular quantos slots estão sendo usados
      const slotsUsed = processedFiles.length;
      const limitReached = slotsUsed >= MAX_FILES_PROCESSED;
      
      // PASSO 5: Distribuir slots para arquivos válidos
      uploadedFiles.forEach(item => {
        if (!item.valid) {
          item.hasSlot = false;
          return;
        }
        
        // Se está na lista de processados, sempre tem slot
        if (processedFiles.includes(item)) {
          item.hasSlot = true;
        } else {
          // Arquivo válido não-marcado:
          // - Se limite NÃO foi atingido: tem slot (aguardando seleção)
          // - Se limite foi atingido: sem slot (não será usado)
          item.hasSlot = !limitReached;
        }
      });
      
      // PASSO 6: Criar estados para renderização
      const fileStates = uploadedFiles.map((item, index) => {
        // Encontrar posição na lista de processados (1-10)
        const processedIndex = processedFiles.indexOf(item);
        const willBeProcessed = processedIndex !== -1;
        const processingNumber = willBeProcessed ? processedIndex + 1 : null;
        
        return {
          item,
          index,
          isInTop10Slots: item.hasSlot,
          willBeProcessed,
          processingNumber
        };
      });
      
      // Agora renderizar com base nessa informação
      fileStates.forEach(({ item, index, isInTop10Slots, willBeProcessed, processingNumber }) => {
        
        const row = document.createElement('tr');
        row.className = `bg-white hover:bg-gray-50 ${willBeProcessed ? 'border-l-4 border-green-500' : item.valid ? 'border-l-4 border-gray-300' : 'border-l-4 border-red-300'}`;
        row.draggable = true;
        row.dataset.fileId = item.id;
        
        const fileType = item.file.type || 'desconhecido';
        const fileSize = (item.file.size / 1024).toFixed(1);
        const fileTypeLabel = fileType.startsWith('image/') ? '🖼️ Imagem' : 
                             fileType === 'text/plain' ? '📝 Texto' : 
                             '📎 Arquivo';
        
        // Status badge
        let statusBadge = '';
        if (!item.valid) {
          statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">❌ Inválido</span>
                        <div class="text-xs text-red-600 mt-1">${item.error}</div>`;
        } else if (willBeProcessed) {
          statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">✓ Será usado (${processingNumber}/10)</span>`;
        } else if (item.valid && isInTop10Slots && !item.enabled) {
          // Arquivo tem slot disponível mas não foi marcado pelo usuário
          statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">○ Aguardando seleção</span>
                        <div class="text-xs text-blue-600 mt-1">Marque o checkbox para usar</div>`;
        } else {
          statusBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">Não será usado</span>
                        <div class="text-xs text-gray-500 mt-1">Limite de 10 arquivos atingido</div>`;
        }
        
        // Determinar se checkbox deve ser desabilitado
        // Checkbox habilitado apenas para arquivos válidos que tenham um slot (primeiros 10 válidos)
        const checkboxDisabled = !item.valid || !isInTop10Slots;
        
        // Determinar cor de fundo da primeira coluna
        let dragColumnBg = 'bg-gray-100'; // padrão
        let dragIconColor = 'text-gray-500';
        
        if (!item.valid) {
          dragColumnBg = 'bg-red-100';
          dragIconColor = 'text-red-600';
        } else if (willBeProcessed) {
          dragColumnBg = 'bg-green-100';
          dragIconColor = 'text-green-600';
        } else if (item.valid && isInTop10Slots && !item.enabled) {
          // Arquivo tem slot disponível mas aguardando seleção
          dragColumnBg = 'bg-blue-100';
          dragIconColor = 'text-blue-600';
        } else {
          dragColumnBg = 'bg-gray-100';
          dragIconColor = 'text-gray-500';
        }
        
        row.innerHTML = `
          <td class="px-3 py-2 ${dragColumnBg} text-center cursor-move">
            <svg class="w-4 h-4 inline ${dragIconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
            </svg>
          </td>
          <td class="px-3 py-2">
            <div class="text-gray-900 font-medium">${item.file.name}</div>
            <div class="text-xs text-gray-500">${fileTypeLabel} · ${fileSize} KB</div>
          </td>
          <td class="px-3 py-2">
            ${statusBadge}
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" ${item.enabled ? 'checked' : ''} ${checkboxDisabled ? 'disabled' : ''}
              data-file-id="${item.id}" 
              class="file-checkbox w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 ${checkboxDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
          </td>
          <td class="px-3 py-2 text-center">
            <button class="text-red-600 hover:text-red-800 text-sm" data-file-remove="${item.id}" title="Remover">
              <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </td>
        `;
        
        filesTableBody.appendChild(row);
        
        // Drag & Drop events
        row.addEventListener('dragstart', (e) => {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', item.id);
          row.classList.add('opacity-50');
        });
        
        row.addEventListener('dragend', (e) => {
          row.classList.remove('opacity-50');
        });
        
        row.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          row.classList.add('border-t-2', 'border-indigo-500');
        });
        
        row.addEventListener('dragleave', (e) => {
          row.classList.remove('border-t-2', 'border-indigo-500');
        });
        
        row.addEventListener('drop', (e) => {
          e.preventDefault();
          row.classList.remove('border-t-2', 'border-indigo-500');
          
          const draggedId = e.dataTransfer.getData('text/html');
          const draggedIndex = uploadedFiles.findIndex(f => f.id === draggedId);
          const targetIndex = uploadedFiles.findIndex(f => f.id === item.id);
          
          if (draggedIndex !== -1 && targetIndex !== -1 && draggedIndex !== targetIndex) {
            // Remover e reinserir
            const [draggedItem] = uploadedFiles.splice(draggedIndex, 1);
            uploadedFiles.splice(targetIndex, 0, draggedItem);
            renderFilesTable();
          }
        });
      });
      
      // Adicionar event listeners
      document.querySelectorAll('.file-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const fileId = e.target.dataset.fileId;
          const file = uploadedFiles.find(f => f.id === fileId);
          if(file) {
            file.enabled = e.target.checked;
            file.manuallySet = true; // Marcar que foi alterado manualmente
            renderFilesTable(); // Re-renderizar para atualizar indicadores visuais
          }
        });
      });
      
      document.querySelectorAll('[data-file-remove]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const fileId = e.currentTarget.dataset.fileRemove;
          uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
          renderFilesTable();
        });
      });
      
      updateFileWarnings();
    }

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      files.forEach(file => {
        const id = `file_${Date.now()}_${Math.random().toString(36).substring(7)}`;
        const validation = validateFile(file);
        
        uploadedFiles.push({
          file: file,
          enabled: validation.valid, // Apenas habilitado se válido
          id: id,
          valid: validation.valid,
          error: validation.error
        });
      });
      renderFilesTable();
      // Limpar input para permitir selecionar os mesmos arquivos novamente
      e.target.value = '';
    });

    // Revalidar arquivos ao trocar de LLM
    llm.addEventListener('change', () => {
      updateFileAccept();
      // Revalidar todos os arquivos
      uploadedFiles.forEach(item => {
        const validation = validateFile(item.file);
        item.valid = validation.valid;
        item.error = validation.error;
        if (!validation.valid) {
          item.enabled = false; // Desabilitar se tornou inválido
        }
      });
      renderFilesTable();
    });
    
    updateFileAccept(); // Inicializar

    // Controles TTS Flutuantes
    const ttsSection = $("#ttsSection");
    const floatingTTS = $("#floatingTTS");
    const ttsPlayFloat = $("#ttsPlayFloat");
    const ttsPrevFloat = $("#ttsPrevFloat");
    const ttsNextFloat = $("#ttsNextFloat");
    const ttsPauseFloat = $("#ttsPauseFloat");
    const ttsStopFloat = $("#ttsStopFloat");
    const ttsRateFloat = $("#ttsRateFloat");

    // Observador de Interseção para mostrar/esconder controles flutuantes
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          floatingTTS.classList.remove("show");
        } else {
          floatingTTS.classList.add("show");
        }
      });
    }, { threshold: 0.1 });

    if (ttsSection) observer.observe(ttsSection);

    // Sincronizar botões flutuantes com originais
    ttsPlayFloat.addEventListener("click", () => $("#ttsPlay").click());
    ttsPrevFloat.addEventListener("click", () => $("#ttsPrev").click());
    ttsNextFloat.addEventListener("click", () => $("#ttsNext").click());
    ttsPauseFloat.addEventListener("click", () => $("#ttsPause").click());
    ttsStopFloat.addEventListener("click", () => $("#ttsStop").click());
    ttsRateFloat.addEventListener("click", () => $("#ttsRate").click());

    // Prompt Modal
    const promptModal=$("#promptModal"); const promptTitleEl=$("#promptTitle"); const promptTextEl=$("#promptText");
    const promptOk=$("#promptOk"); const promptCancel=$("#promptCancel"); let promptResolve=null;
    function openPrompt(title){ promptTitleEl.textContent=title||"Instruções adicionais"; promptTextEl.value=""; promptModal.classList.add("open"); return new Promise(res=>{promptResolve=res}); }
    promptCancel.addEventListener("click", ()=>{ promptModal.classList.remove("open"); if(promptResolve) promptResolve(null); });
    promptOk.addEventListener("click", ()=>{ promptModal.classList.remove("open"); if(promptResolve) promptResolve(promptTextEl.value); });

    // Config Modal
    const cfgModal = $("#configModal"); const btnConfig = $("#btnConfig");
    const cfgOpenAI=$("#cfgOpenAI"), cfgOpenAIBase=$("#cfgOpenAIBase");
    const cfgGemini=$("#cfgGemini"), cfgGeminiBase=$("#cfgGeminiBase");
    const cfgRules=$("#cfgRules"), cfgPromptTpl=$("#cfgPromptTpl");
    const cfgSave=$("#cfgSave"), cfgCancel=$("#cfgCancel"), cfgClose=$("#cfgClose");
    const cfgAddTiny=$("#cfgAddTiny"), cfgTinyTokensList=$("#cfgTinyTokensList");
    
    // Funções para gerenciar tokens Tiny
    function getTinyTokens() {
      const saved = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      return saved.tiny_tokens || [];
    }
    
    function saveTinyTokens(tokens) {
      const saved = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      saved.tiny_tokens = tokens;
      localStorage.setItem(LS_KEY, JSON.stringify(saved));
    }
    
    function renderTinyTokensList() {
      const tokens = getTinyTokens();
      if (tokens.length === 0) {
        cfgTinyTokensList.innerHTML = '<p class="text-xs text-gray-500 italic">Nenhum token configurado</p>';
        return;
      }
      
      cfgTinyTokensList.innerHTML = tokens.map((token, idx) => `
        <div class="flex gap-2 items-center p-2 bg-gray-50 rounded border border-gray-200">
          <input type="text" class="flex-1 rounded-md border border-gray-300 px-2 py-1 text-sm" 
                 value="${token.label}" data-idx="${idx}" data-field="label" placeholder="Nome da instância">
          <input type="password" class="flex-1 rounded-md border border-gray-300 px-2 py-1 text-sm" 
                 value="${token.token}" data-idx="${idx}" data-field="token" placeholder="Token API">
          <button class="btn text-xs" data-remove-tiny="${idx}" title="Remover">
            <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="1.5"/></svg>
          </button>
        </div>
      `).join('');
      
      // Event listeners
      cfgTinyTokensList.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          const tokens = getTinyTokens();
          tokens[idx][field] = e.target.value;
          saveTinyTokens(tokens);
        });
      });
      
      cfgTinyTokensList.querySelectorAll('[data-remove-tiny]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.dataset.removeTiny);
          const tokens = getTinyTokens();
          tokens.splice(idx, 1);
          saveTinyTokens(tokens);
          renderTinyTokensList();
          updateTinyInstanceSelect();
        });
      });
    }
    
    cfgAddTiny.addEventListener('click', () => {
      const tokens = getTinyTokens();
      tokens.push({ label: '', token: '' });
      saveTinyTokens(tokens);
      renderTinyTokensList();
    });
    
    function updateTinyInstanceSelect() {
      const tokens = getTinyTokens();
      tinyInstance.innerHTML = '';
      
      if (tokens.length === 0) {
        tinyInstance.innerHTML = '<option value="">Nenhuma instância Tiny cadastrada</option>';
        tinyInstance.disabled = true;
      } else {
        tinyInstance.innerHTML = '<option value="">Selecione uma instância</option>' +
          tokens.map((t, idx) => `<option value="${idx}">${t.label || 'Instância ' + (idx+1)}</option>`).join('');
        tinyInstance.disabled = false;
      }
      
      updateIntegrationMode();
    }

    // ============================================================================
    // PRICING CONFIG - Dados de Precificação
    // ============================================================================
    const cfgAddPricing = $("#cfgAddPricing");
    const cfgPricingTableBody = $("#cfgPricingTableBody");
    
    // Configuração padrão para cada marketplace
    const DEFAULT_PRICING_CONFIG = {
      mercadolivre: { marketplace: 'mercadolivre', comissao_min: 12, comissao_max: 17, tacos: 5, margem_contribuicao: 15, lucro: 10, impostos: 8 },
      shopee: { marketplace: 'shopee', comissao_min: 10, comissao_max: 15, tacos: 5, margem_contribuicao: 15, lucro: 10, impostos: 8 },
      amazon: { marketplace: 'amazon', comissao_min: 12, comissao_max: 18, tacos: 5, margem_contribuicao: 15, lucro: 10, impostos: 8 },
      magalu: { marketplace: 'magalu', comissao_min: 12, comissao_max: 16, tacos: 5, margem_contribuicao: 15, lucro: 10, impostos: 8 },
      shein: { marketplace: 'shein', comissao_min: 10, comissao_max: 15, tacos: 5, margem_contribuicao: 15, lucro: 10, impostos: 8 }
    };
    
    function getPricingConfig() {
      const saved = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      return saved.pricing_config || [];
    }
    
    function savePricingConfig(config) {
      const saved = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      saved.pricing_config = config;
      localStorage.setItem(LS_KEY, JSON.stringify(saved));
    }
    
    function renderPricingTable() {
      const config = getPricingConfig();
      
      if (config.length === 0) {
        cfgPricingTableBody.innerHTML = '<tr><td colspan="8" class="px-3 py-4 text-center text-gray-500 italic">Nenhuma configuração de preço cadastrada</td></tr>';
        return;
      }
      
      cfgPricingTableBody.innerHTML = config.map((item, idx) => `
        <tr class="hover:bg-gray-50">
          <td class="px-2 py-2">
            <select class="w-full rounded border border-gray-300 px-2 py-1 text-xs" data-idx="${idx}" data-field="marketplace">
              <option value="mercadolivre" ${item.marketplace === 'mercadolivre' ? 'selected' : ''}>Mercado Livre</option>
              <option value="shopee" ${item.marketplace === 'shopee' ? 'selected' : ''}>Shopee</option>
              <option value="amazon" ${item.marketplace === 'amazon' ? 'selected' : ''}>Amazon</option>
              <option value="magalu" ${item.marketplace === 'magalu' ? 'selected' : ''}>Magalu</option>
              <option value="shein" ${item.marketplace === 'shein' ? 'selected' : ''}>Shein</option>
            </select>
          </td>
          <td class="px-2 py-2"><input type="number" min="0" max="100" step="0.1" class="w-full rounded border border-gray-300 px-2 py-1 text-xs text-center" value="${item.comissao_min}" data-idx="${idx}" data-field="comissao_min"></td>
          <td class="px-2 py-2"><input type="number" min="0" max="100" step="0.1" class="w-full rounded border border-gray-300 px-2 py-1 text-xs text-center" value="${item.comissao_max}" data-idx="${idx}" data-field="comissao_max"></td>
          <td class="px-2 py-2"><input type="number" min="0" max="100" step="0.1" class="w-full rounded border border-gray-300 px-2 py-1 text-xs text-center" value="${item.tacos}" data-idx="${idx}" data-field="tacos"></td>
          <td class="px-2 py-2"><input type="number" min="0" max="100" step="0.1" class="w-full rounded border border-gray-300 px-2 py-1 text-xs text-center" value="${item.margem_contribuicao}" data-idx="${idx}" data-field="margem_contribuicao"></td>
          <td class="px-2 py-2"><input type="number" min="0" max="100" step="0.1" class="w-full rounded border border-gray-300 px-2 py-1 text-xs text-center" value="${item.lucro}" data-idx="${idx}" data-field="lucro"></td>
          <td class="px-2 py-2"><input type="number" min="0" max="100" step="0.1" class="w-full rounded border border-gray-300 px-2 py-1 text-xs text-center" value="${item.impostos}" data-idx="${idx}" data-field="impostos"></td>
          <td class="px-2 py-2 text-center">
            <button class="btn text-xs p-1" data-remove-pricing="${idx}" title="Remover">
              <svg class="icon w-4 h-4" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="1.5"/></svg>
            </button>
          </td>
        </tr>
      `).join('');
      
      // Event listeners para inputs
      cfgPricingTableBody.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.idx);
          const field = e.target.dataset.field;
          const config = getPricingConfig();
          
          if (field === 'marketplace') {
            config[idx][field] = e.target.value;
          } else {
            config[idx][field] = parseFloat(e.target.value) || 0;
          }
          
          savePricingConfig(config);
        });
      });
      
      // Event listeners para botões remover
      cfgPricingTableBody.querySelectorAll('[data-remove-pricing]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.dataset.removePricing);
          const config = getPricingConfig();
          config.splice(idx, 1);
          savePricingConfig(config);
          renderPricingTable();
        });
      });
    }
    
    cfgAddPricing.addEventListener('click', () => {
      const config = getPricingConfig();
      const selectedMarketplace = marketplace.value || 'mercadolivre';
      
      // Usar configuração padrão para o marketplace selecionado
      const defaultConfig = DEFAULT_PRICING_CONFIG[selectedMarketplace] || DEFAULT_PRICING_CONFIG['mercadolivre'];
      config.push({ ...defaultConfig });
      
      savePricingConfig(config);
      renderPricingTable();
    });
    
    // Função para obter dados de precificação do marketplace selecionado
    function getPricingDataForMarketplace(marketplaceValue) {
      const config = getPricingConfig();
      const found = config.find(c => c.marketplace === marketplaceValue);
      
      if (!found) {
        return null; // Sem configuração de precificação
      }
      
      // Converter percentuais para decimais
      return {
        comissao_min: found.comissao_min / 100,
        comissao_max: found.comissao_max / 100,
        tacos: found.tacos / 100,
        margem_contribuicao: found.margem_contribuicao / 100,
        lucro: found.lucro / 100,
        impostos: found.impostos / 100
      };
    }

    const DEFAULT_PROMPT_TEMPLATE =
`Produto: "{product}"
Marketplace: {marketplace}
Especificações agregadas (parciais e possivelmente ruidosas): {specs}

Tarefas:
1) TÍTULO (apenas texto, 1 linha) — incluir marca, atributo-chave e variante quando relevante.
2) DESCRIÇÃO (sem emojis; clara, escaneável; 3-6 bullets iniciais + 3-5 parágrafos).
3) FAQ (10 pares Q->A) – foque objeções reais, uso, compatibilidades, garantia, manutenção, devolução.
4) CARDS (11 itens) – para imagens 1200x1200: cada item = { "title": "...", "text": "..." } curto e direto.

Restrições:
- Sem “frete grátis”, “brinde”, “promoção” ou equivalentes.
- Não use emojis. Escreva em português do Brasil.
- Adapte o tom ao marketplace especificado.
- Responda em JSON com as chaves: title, description, faq (array de objetos {q,a}), cards (array de objetos {title,text}).
`;

    // Config Section Navigation
    function switchConfigSection(sectionName) {
      // Remover active de todos os botões e seções
      document.querySelectorAll('.cfg-nav-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.cfg-section').forEach(section => section.style.display = 'none');
      
      // Ativar botão e seção selecionados
      const btn = document.querySelector(`.cfg-nav-btn[data-section="${sectionName}"]`);
      const section = document.querySelector(`.cfg-section[data-section="${sectionName}"]`);
      
      if (btn) btn.classList.add('active');
      if (section) section.style.display = 'block';
    }
    
    // Event listeners para navegação
    document.querySelectorAll('.cfg-nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const section = btn.dataset.section;
        switchConfigSection(section);
      });
    });

    btnConfig.addEventListener("click", ()=> {
      const saved = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      cfgOpenAI.value = saved.openai || "";
      cfgOpenAIBase.value = saved.openai_base || "";
      cfgGemini.value = saved.gemini || "";
      cfgGeminiBase.value = saved.gemini_base || "";
      cfgRules.value = saved.rules ? JSON.stringify(saved.rules, null, 2) : "";
      cfgPromptTpl.value = saved.prompt_template || DEFAULT_PROMPT_TEMPLATE;
      renderTinyTokensList();
      renderPricingTable(); // Renderizar tabela de precificação
      switchConfigSection('llm'); // Sempre abrir na seção LLM
      cfgModal.classList.add("open");
    });
    function closeCfg(){ cfgModal.classList.remove("open"); }
    cfgCancel.addEventListener("click", closeCfg);
    cfgClose.addEventListener("click", closeCfg);
    cfgSave.addEventListener("click", ()=> {
      let rules = {};
      if (cfgRules.value.trim()) {
        try { rules = JSON.parse(cfgRules.value); } catch(e){ alert("RuleSets inválido (JSON). Corrija e tente novamente."); return; }
      }
      const payload = {
        openai: cfgOpenAI.value.trim(),
        openai_base: cfgOpenAIBase.value.trim(),
        gemini: cfgGemini.value.trim(),
        gemini_base: cfgGeminiBase.value.trim(),
        rules,
        prompt_template: cfgPromptTpl.value,
        tiny_tokens: getTinyTokens(),
        pricing_config: getPricingConfig() // Salvar dados de precificação
      };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
      updateTinyInstanceSelect();
      closeCfg();
    });

    // -------- Estado / Histórico --------
    const history = { title:[], titleIdx:-1, description:[], descIdx:-1, faq:[], cards:[], cardLines:[] };
    function persistState(){ localStorage.setItem(LS_STATE, JSON.stringify(history)); }
    function restoreState(){
      try{
        const st = JSON.parse(localStorage.getItem(LS_STATE)||"null");
        if(!st) return;
        Object.assign(history, st);
        if(history.titleIdx>=0) outTitle.value = history.title[history.titleIdx];
        if(history.descIdx>=0) outDesc.value = history.description[history.descIdx];
        renderFAQFromState(); renderCardsFromState(); updateVersionControls(); rebuildPlaylist();
      }catch(e){}
    }
    function resetHistory(){
      // Limpar histórico
      history.title = [];
      history.titleIdx = -1;
      history.description = [];
      history.descIdx = -1;
      history.faq = [];
      history.cards = [];
      history.cardLines = [];
      
      // Limpar interface
      outTitle.value = "";
      outDesc.value = "";
      faqList.innerHTML = "";
      cardsList.innerHTML = "";
      
      // Limpar controles de versão
      updateVersionControls();
      
      // Limpar playlist TTS
      rebuildPlaylist();
      
      // Persistir estado limpo
      persistState();
    }
    function pushHistory(key, value){
      if(key==="title"){
        history.title = history.title.slice(0, history.titleIdx+1);
        history.title.push(value); history.titleIdx = history.title.length-1; outTitle.value=value;
      }else if(key==="description"){
        history.description = history.description.slice(0, history.descIdx+1);
        history.description.push(value); history.descIdx = history.description.length-1; outDesc.value=value;
      }
      persistState(); updateVersionControls(); rebuildPlaylist();
    }
    function navHistory(key, dir){
      if(key==="title"){
        const next = history.titleIdx + dir;
        if(next>=0 && next<history.title.length){ history.titleIdx=next; outTitle.value=history.title[next]; }
      }else if(key==="description"){
        const next = history.descIdx + dir;
        if(next>=0 && next<history.description.length){ history.descIdx=next; outDesc.value=history.description[next]; }
      }
      persistState(); updateVersionControls(); rebuildPlaylist();
    }
    function updateVersionControls(){
      const tCount = history.title.length, tIdx = history.titleIdx;
      const dCount = history.description.length, dIdx = history.descIdx;
      titlePrev.classList.toggle("hidden", !(tCount>1 && tIdx>0));
      titleNext.classList.toggle("hidden", !(tCount>1 && tIdx<tCount-1));
      titleCount.classList.toggle("hidden", !(tCount>1));
      if(tCount>1) titleCount.textContent = `${tIdx+1}/${tCount}`;
      descPrev.classList.toggle("hidden", !(dCount>1 && dIdx>0));
      descNext.classList.toggle("hidden", !(dCount>1 && dIdx<dCount-1));
      descCount.classList.toggle("hidden", !(dCount>1));
      if(dCount>1) descCount.textContent = `${dIdx+1}/${dCount}`;
    }

    // -------- FAQ --------
    function renderFAQ(items){
      history.faq = (items||[]).map(x=>({ approved:true, versions:[{q:x.q,a:x.a}], vIdx:0 }));
      renderFAQFromState();
    }
    function renderFAQFromState(){
      faqList.innerHTML = "";
      history.faq.forEach((line, idx)=>{
        const cur = line.versions[line.vIdx];
        const el = document.createElement("div");
        el.className = "relative rounded-md p-3 text-sm bg-white border " + (line.approved ? "border-gray-200" : "border-red-400");
        el.innerHTML = `
          <div class="label-row mb-1">
            <div class="toolbar">
              <button class="btn" data-action="prev" title="Versão anterior" ${line.vIdx>0?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
              <span class="muted" data-role="count" ${line.versions.length>1?"":"style='display:none'"}>${line.vIdx+1}/${line.versions.length}</span>
              <button class="btn" data-action="next" title="Próxima versão" ${(line.vIdx<line.versions.length-1)?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="regen" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="prompt" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="approve" title="${line.approved ? 'Desabilitar FAQ' : 'Habilitar FAQ'}">
                ${line.approved 
                  ? '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l3 3 5-6" stroke-width="1.5"/></svg>'
                  : '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M15 9l-6 6M9 9l6 6" stroke-width="1.5"/></svg>'
                }
              </button>
            </div>
            <div class="floating-right">
              <button class="btn" data-action="copy" title="Copiar item"><svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg></button>
            </div>
          </div>
          <div class="font-medium text-gray-800">P: <span class="q"></span></div>
          <div class="text-gray-700 mt-1">R: <span class="a"></span></div>
        `;
        const qEl = el.querySelector(".q"), aEl = el.querySelector(".a");
        qEl.textContent = cur.q; aEl.textContent = cur.a;

        function setProcessing(on){
          if(on){ qEl.parentElement.classList.add("pulse"); aEl.parentElement.classList.add("pulse"); }
          else{ qEl.parentElement.classList.remove("pulse"); aEl.parentElement.classList.remove("pulse"); }
        }

        const prevBtn = el.querySelector('[data-action="prev"]');
        if(prevBtn) prevBtn.addEventListener("click", ()=>{ if(line.vIdx>0){ line.vIdx--; renderFAQFromState(); persistState(); rebuildPlaylist(); } });
        const nextBtn = el.querySelector('[data-action="next"]');
        if(nextBtn) nextBtn.addEventListener("click", ()=>{ if(line.vIdx<line.versions.length-1){ line.vIdx++; renderFAQFromState(); persistState(); rebuildPlaylist(); } });

        el.querySelector('[data-action="copy"]').addEventListener("click", (e)=> {
          navigator.clipboard.writeText(`P: ${cur.q}\nR: ${cur.a}`);
          showCopyFeedback(e.currentTarget);
        });
        el.querySelector('[data-action="approve"]').addEventListener("click", ()=> {
          line.approved = !line.approved;
          el.className = "relative rounded-md p-3 text-sm bg-white border " + (line.approved ? "border-gray-200" : "border-red-400");
          persistState(); rebuildPlaylist();
        });
        el.querySelector('[data-action="regen"]').addEventListener("click", async ()=>{ setProcessing(true); await regenFAQ(idx); setProcessing(false); });
        el.querySelector('[data-action="prompt"]').addEventListener("click", async ()=>{ const txt = await openPrompt("Instruções para regerar esta FAQ:"); if(txt!==null){ setProcessing(true); await regenFAQ(idx, txt); setProcessing(false); } });

        faqList.appendChild(el);
      });
      persistState(); rebuildPlaylist();
    }

    // -------- Cards --------
    function renderCards(items){
      history.cardLines = (items||[]).map(x=>({ versions:[{title:x.title||"", text:x.text||""}], vIdx:0, copiedTitle: false, copiedText: false }));
      buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist();
    }
    function buildCurrentCards(){ history.cards = history.cardLines.map(l => l.versions[l.vIdx]); }
    function renderCardsFromState(){
      cardsList.innerHTML = "";
      history.cardLines.forEach((line, idx)=>{
        const cur = line.versions[line.vIdx];
        const el = document.createElement("div");
        
        // Determinar cor da borda baseado no estado de cópia
        let borderClass = "border-gray-200";
        const copiedCount = (line.copiedTitle ? 1 : 0) + (line.copiedText ? 1 : 0);
        if (copiedCount === 1) borderClass = "border-yellow-400";
        else if (copiedCount === 2) borderClass = "border-green-400";
        
        el.className = `relative border ${borderClass} rounded-md p-3 text-sm bg-white`;
        el.innerHTML = `
          <div class="label-row mb-1">
            <div class="toolbar">
              <button class="btn" data-action="prev" title="Versão anterior" ${line.vIdx>0?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
              <span class="muted" data-role="count" ${line.versions.length>1?"":"style='display:none'"}>${line.vIdx+1}/${line.versions.length}</span>
              <button class="btn" data-action="next" title="Próxima versão" ${(line.vIdx<line.versions.length-1)?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="regen" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="prompt" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
            </div>
            <div class="floating-right"></div>
          </div>
          <div class="font-medium text-gray-800 flex items-center justify-between">
            <span><b>Título:</b> <span class="ctitle"></span></span>
            <button class="btn" data-action="copyTitle" title="Copiar título">
              ${line.copiedTitle 
                ? '<svg class="icon-fill" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>'
                : '<svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>'
              }
            </button>
          </div>
          <div class="text-gray-700 flex items-center justify-between mt-1">
            <span><b>Texto:</b> <span class="ctext"></span></span>
            <button class="btn" data-action="copyText" title="Copiar texto">
              ${line.copiedText
                ? '<svg class="icon-fill" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>'
                : '<svg class="icon" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="1.5" fill="none"/></svg>'
              }
            </button>
          </div>
        `;
        const tEl = el.querySelector(".ctitle"), xEl = el.querySelector(".ctext");
        tEl.textContent = cur.title; xEl.textContent = cur.text;

        function setProcessing(on){
          if(on){ tEl.parentElement.classList.add("pulse"); xEl.parentElement.classList.add("pulse"); }
          else { tEl.parentElement.classList.remove("pulse"); xEl.parentElement.classList.remove("pulse"); }
        }

        const prevBtn = el.querySelector('[data-action="prev"]');
        if(prevBtn) prevBtn.addEventListener("click", ()=>{ 
          if(line.vIdx>0){ 
            line.vIdx--; 
            line.copiedTitle = false;
            line.copiedText = false;
            buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist(); 
          } 
        });
        const nextBtn = el.querySelector('[data-action="next"]');
        if(nextBtn) nextBtn.addEventListener("click", ()=>{ 
          if(line.vIdx<line.versions.length-1){ 
            line.vIdx++; 
            line.copiedTitle = false;
            line.copiedText = false;
            buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist(); 
          } 
        });
        el.querySelector('[data-action="regen"]').addEventListener("click", async ()=>{ setProcessing(true); await regenCard(idx); setProcessing(false); });
        el.querySelector('[data-action="prompt"]').addEventListener("click", async ()=>{ const txt = await openPrompt("Instruções para regerar este card:"); if(txt!==null){ setProcessing(true); await regenCard(idx, txt); setProcessing(false); } });

        el.querySelector('[data-action="copyTitle"]').addEventListener("click", (e)=> {
          navigator.clipboard.writeText(cur.title||"");
          line.copiedTitle = true;
          showCopyFeedback(e.currentTarget);
          renderCardsFromState();
          persistState();
        });
        el.querySelector('[data-action="copyText"]').addEventListener("click", (e)=> {
          navigator.clipboard.writeText(cur.text||"");
          line.copiedText = true;
          showCopyFeedback(e.currentTarget);
          renderCardsFromState();
          persistState();
        });

        cardsList.appendChild(el);
      });
    }

    // -------- TTS / Playlist --------
    let playlist = []; let curIdx = -1; let autoplay = true; let rate = parseFloat(localStorage.getItem(LS_TTS_RATE) || "1") || 1;
    let isPaused = false;
    const ttsNow = $("#ttsNow"); const ttsAuto = $("#ttsAuto"); const ttsRateBtn = $("#ttsRate");
    ttsRateBtn.textContent = rate+"x";
    ttsRateFloat.textContent = rate+"x";

    function rebuildPlaylist(){
      // Salvar o item atual antes de reconstruir
      const currentItem = (curIdx >= 0 && curIdx < playlist.length) ? playlist[curIdx] : null;
      
      playlist = [];
      if(outTitle.value.trim()) playlist.push({label:"Título", text: outTitle.value.trim(), element: outTitle, type: "field"});
      if(outDesc.value.trim()) playlist.push({label:"Descrição", text: outDesc.value.trim(), element: outDesc, type: "field"});
      
      // Para FAQ, guardar o índice original no array history.faq (não o índice no array filtrado)
      history.faq.forEach((f, originalIdx) => {
        if(f.approved){
          const cur = f.versions[f.vIdx];
          const approvedIdx = history.faq.slice(0, originalIdx).filter(x => x.approved).length;
          playlist.push({
            label:`FAQ ${approvedIdx+1}`, 
            text:`Pergunta: ${cur.q}. Resposta: ${cur.a}.`, 
            type: "faq", 
            index: approvedIdx,
            originalIndex: originalIdx  // Índice real no array history.faq
          });
        }
      });
      
      // Para Cards, guardar o índice original também
      (history.cards||[]).forEach((c,i)=> playlist.push({
        label:`Card ${i+1}`, 
        text:`${c.title}. ${c.text}`, 
        type: "card", 
        index: i,
        originalIndex: i
      }));
      
      // Tentar manter o mesmo item lógico após reconstruir usando originalIndex
      if(currentItem){
        const newIdx = playlist.findIndex(item => {
          if(item.type !== currentItem.type) return false;
          
          // Para FAQ e Card, usar originalIndex para identificação precisa
          if(item.type === "faq" || item.type === "card"){
            // Tentar por originalIndex primeiro
            if(currentItem.originalIndex !== undefined && item.originalIndex === currentItem.originalIndex){
              return true;
            }
            // Fallback para compatibilidade: comparar por texto se originalIndex não existe
            if(currentItem.originalIndex === undefined){
              return item.text === currentItem.text;
            }
            return false;
          }
          
          // Para outros tipos (título, descrição), usar label e texto
          return item.label === currentItem.label && item.text === currentItem.text;
        });
        
        if(newIdx >= 0){
          curIdx = newIdx; // Encontrou o mesmo item
        } else {
          // Item não existe mais, ajustar para o mais próximo
          curIdx = Math.min(curIdx, playlist.length - 1);
        }
      }
      
      if(curIdx >= playlist.length) curIdx = playlist.length - 1;
      if(curIdx === -1 && playlist.length) curIdx = 0;
    }
    let currentHighlightElement = null;
    let originalContent = "";
    
    function clearHighlight(){
      if(currentHighlightElement){
        if(currentHighlightElement.tagName === "TEXTAREA" || currentHighlightElement.tagName === "INPUT"){
          // Remover seleção dos campos de texto
          currentHighlightElement.setSelectionRange(0, 0);
          currentHighlightElement.blur();
        } else {
          currentHighlightElement.innerHTML = originalContent;
        }
        currentHighlightElement = null;
        originalContent = "";
      }
    }
    
    function speakCurrent(){
      if(curIdx < 0 || curIdx >= playlist.length) return;
      clearHighlight();
      
      const part = playlist[curIdx];
      ttsNow.textContent = `Lendo: ${part.label} (${rate}x)`;
      window.speechSynthesis.cancel();
      isPaused = false;
      
      const utter = new SpeechSynthesisUtterance(part.text);
      utter.lang = "pt-BR"; utter.rate = rate;
      
      // Dividir texto em palavras para highlight
      const words = part.text.split(/(\s+)/); // Mantém os espaços
      let currentWordIndex = 0;
      
      // Scroll para o elemento atual
      if(part.element){
        part.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        currentHighlightElement = part.element;
      } else if(part.type === "faq"){
        const faqElements = faqList.querySelectorAll('.relative');
        const faqIndex = part.originalIndex !== undefined ? part.originalIndex : part.index;
        if(faqElements[faqIndex]){
          faqElements[faqIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } else if(part.type === "card"){
        const cardElements = cardsList.querySelectorAll('.relative');
        const cardIndex = part.originalIndex !== undefined ? part.originalIndex : part.index;
        if(cardElements[cardIndex]){
          cardElements[cardIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
      
      utter.onboundary = (event) => {
        if(event.name === 'word'){
          const wordStart = event.charIndex;
          const wordEnd = event.charIndex + event.charLength;
          
          // Aplicar highlight se for um campo de texto (usando seleção nativa)
          if(part.element && (part.element.tagName === "TEXTAREA" || part.element.tagName === "INPUT")){
            part.element.focus();
            part.element.setSelectionRange(wordStart, wordEnd);
            
            // Auto-scroll do campo para mostrar a seleção
            if(part.element.tagName === "TEXTAREA"){
              // Usar técnica de medição real da posição do cursor
              const textareaStyle = getComputedStyle(part.element);
              const lineHeight = parseFloat(textareaStyle.lineHeight) || 20;
              
              // Criar elemento temporário para medir posição real do texto
              const mirror = document.createElement('div');
              mirror.style.cssText = `
                position: absolute;
                visibility: hidden;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-wrap: break-word;
                width: ${part.element.clientWidth - parseFloat(textareaStyle.paddingLeft) - parseFloat(textareaStyle.paddingRight)}px;
                font: ${textareaStyle.font};
                padding: ${textareaStyle.padding};
                border: ${textareaStyle.border};
                line-height: ${textareaStyle.lineHeight};
              `;
              
              // Adicionar texto até o cursor
              mirror.textContent = part.element.value.substring(0, wordStart);
              document.body.appendChild(mirror);
              
              // Medir altura real
              const cursorHeight = mirror.offsetHeight;
              document.body.removeChild(mirror);
              
              // Calcular scroll ideal para centralizar
              const visibleHeight = part.element.clientHeight;
              const idealScrollTop = cursorHeight - (visibleHeight / 2) + (lineHeight / 2);
              
              // Aplicar scroll
              part.element.scrollTop = Math.max(0, idealScrollTop);
            }
          } else if(part.type === "faq" || part.type === "card"){
            // Para FAQ e Cards, destacar a palavra no elemento de texto
            const containerList = part.type === "faq" ? faqList : cardsList;
            const items = containerList.querySelectorAll('.relative');
            // Usar originalIndex para encontrar o elemento correto (items contém todos, não só aprovados)
            const itemIndex = part.originalIndex !== undefined ? part.originalIndex : part.index;
            if(items[itemIndex]){
              let targetSpan = null;
              let localStart = wordStart;
              let localEnd = wordEnd;
              
              if(part.type === "faq"){
                const qSpan = items[itemIndex].querySelector('.q');
                const aSpan = items[itemIndex].querySelector('.a');
                const qPrefix = "Pergunta: ";
                const qText = qSpan ? qSpan.textContent : "";
                const aSeparator = ". Resposta: ";
                const aText = aSpan ? aSpan.textContent : "";
                
                const qEnd = qPrefix.length + qText.length;
                const aStart = qEnd + aSeparator.length;
                
                if(wordStart < qEnd){
                  // Palavra está na pergunta
                  targetSpan = qSpan;
                  localStart = wordStart - qPrefix.length;
                  localEnd = wordEnd - qPrefix.length;
                } else if(wordStart >= aStart){
                  // Palavra está na resposta
                  targetSpan = aSpan;
                  localStart = wordStart - aStart;
                  localEnd = wordEnd - aStart;
                }
              } else if(part.type === "card"){
                const titleSpan = items[itemIndex].querySelector('.ctitle');
                const textSpan = items[itemIndex].querySelector('.ctext');
                const titleText = titleSpan ? titleSpan.textContent : "";
                const separator = ". ";
                const titleEnd = titleText.length;
                const textStart = titleEnd + separator.length;
                
                if(wordStart < titleEnd){
                  // Palavra está no título
                  targetSpan = titleSpan;
                  localStart = wordStart;
                  localEnd = wordEnd;
                } else if(wordStart >= textStart){
                  // Palavra está no texto
                  targetSpan = textSpan;
                  localStart = wordStart - textStart;
                  localEnd = wordEnd - textStart;
                }
              }
              
              if(targetSpan && localStart >= 0){
                const text = targetSpan.textContent;
                if(localStart < text.length){
                  // Salvar conteúdo original apenas uma vez
                  if(currentHighlightElement !== targetSpan){
                    if(currentHighlightElement){
                      currentHighlightElement.innerHTML = originalContent;
                    }
                    originalContent = targetSpan.innerHTML;
                    currentHighlightElement = targetSpan;
                  }
                  
                  // Construir HTML com highlight
                  const before = text.substring(0, Math.max(0, localStart));
                  const highlighted = text.substring(Math.max(0, localStart), Math.min(text.length, localEnd));
                  const after = text.substring(Math.min(text.length, localEnd));
                  
                  targetSpan.innerHTML = before + '<span class="tts-highlight">' + highlighted + '</span>' + after;
                }
              }
            }
          }
        }
      };
      
      utter.onend = ()=> { 
        clearHighlight();
        if(autoplay && curIdx < playlist.length-1){ 
          curIdx++; 
          speakCurrent(); 
        } else {
          $("#ttsPlay").classList.remove("tts-active");
          ttsPlayFloat.classList.remove("tts-active");
        }
      };
      
      $("#ttsPlay").classList.add("tts-active");
      ttsPlayFloat.classList.add("tts-active");
      $("#ttsPause").classList.remove("tts-active");
      ttsPauseFloat.classList.remove("tts-active");
      window.speechSynthesis.speak(utter);
    }
    $("#ttsPlay").addEventListener("click", ()=> { 
      if(curIdx<0 && playlist.length){curIdx=0;} 
      autoplay = true; 
      ttsAuto.textContent="Autoplay ON"; 
      $("#ttsPlay").classList.add("tts-active");
      ttsPlayFloat.classList.add("tts-active");
      $("#ttsPause").classList.remove("tts-active");
      ttsPauseFloat.classList.remove("tts-active");
      
      if(isPaused) {
        window.speechSynthesis.resume();
        isPaused = false;
      } else {
        speakCurrent();
      }
    });
    $("#ttsPrev").addEventListener("click", ()=> { if(curIdx>0){ curIdx--; isPaused=false; speakCurrent(); } });
    $("#ttsNext").addEventListener("click", ()=> { if(curIdx<playlist.length-1){ curIdx++; isPaused=false; speakCurrent(); } });
    $("#ttsPause").addEventListener("click", ()=> { 
      autoplay=false; 
      ttsAuto.textContent="Autoplay OFF"; 
      $("#ttsPause").classList.add("tts-active");
      ttsPauseFloat.classList.add("tts-active");
      $("#ttsPlay").classList.remove("tts-active");
      ttsPlayFloat.classList.remove("tts-active");
      isPaused = true;
      window.speechSynthesis.pause(); 
    });
    $("#ttsStop").addEventListener("click", ()=> { 
      autoplay=false; 
      ttsAuto.textContent="Autoplay OFF"; 
      $("#ttsPlay").classList.remove("tts-active");
      ttsPlayFloat.classList.remove("tts-active");
      $("#ttsPause").classList.remove("tts-active");
      ttsPauseFloat.classList.remove("tts-active");
      isPaused = false;
      window.speechSynthesis.cancel(); 
      clearHighlight();
      ttsNow.textContent=""; 
      // Voltar ao início (título)
      curIdx = 0;
    });
    ttsRateBtn.addEventListener("click", ()=> {
      let next = 1;
      if(rate===1) next=1.5; else if(rate===1.5) next=2; else next=1;
      rate = next; localStorage.setItem(LS_TTS_RATE, String(rate));
      ttsRateBtn.textContent = rate+"x";
      ttsRateFloat.textContent = rate+"x";
      if(window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); speakCurrent(); }
    });

    // -------- Regenerações (backend) --------
    async function regenTitle(withPrompt=false){
      outTitle.classList.add("pulse");
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      let promptText = "";
      if(withPrompt){ const txt = await openPrompt("Instruções para regerar o título:"); if(txt===null){ outTitle.classList.remove("pulse"); return; } promptText = txt; }
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "title",
        prompt: promptText,
        context: { previous: outTitle.value },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      try {
        const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
        const data = await r.json();
        if(data.title && data.title !== outTitle.value){ pushHistory("title", data.title); }
      } finally { outTitle.classList.remove("pulse"); }
    }
    async function regenDesc(withPrompt=false){
      outDesc.classList.add("pulse");
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      let promptText = "";
      if(withPrompt){ const txt = await openPrompt("Instruções para regerar a descrição:"); if(txt===null){ outDesc.classList.remove("pulse"); return; } promptText = txt; }
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "description",
        prompt: promptText,
        context: { previous: outDesc.value },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      try {
        const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
        const data = await r.json();
        if(data.description && data.description !== outDesc.value){ pushHistory("description", data.description); }
      } finally { outDesc.classList.remove("pulse"); }
    }
    async function regenFAQ(index, promptText=""){
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "faq_item",
        index,
        prompt: promptText,
        context: { previous: history.faq[index].versions[history.faq[index].vIdx] },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
      const data = await r.json();
      const item = (data.faq && data.faq[0]) ? data.faq[0] : null;
      if(item){
        const line = history.faq[index];
        const curt = line.versions[line.vIdx];
        // SEMPRE adicionar nova versão ao histórico (mesmo se for igual, para transparência)
        line.versions = line.versions.slice(0, line.vIdx+1);
        line.versions.push({q:item.q||curt.q, a:item.a||curt.a});
        line.vIdx = line.versions.length-1;
        renderFAQFromState();
      }
    }
    async function regenCard(index, promptText=""){
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "card",
        index,
        prompt: promptText,
        context: { previous: history.cardLines[index].versions[history.cardLines[index].vIdx] },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
      const data = await r.json();
      const item = (data.cards && data.cards[0]) ? data.cards[0] : null;
      if(item){
        const line = history.cardLines[index];
        const cur = line.versions[line.vIdx];
        // SEMPRE adicionar nova versão ao histórico (mesmo se for igual, para transparência)
        line.versions = line.versions.slice(0, line.vIdx+1);
        line.versions.push({title:item.title||cur.title, text:item.text||cur.text});
        line.vIdx = line.versions.length-1;
        // Reset copy state when regenerating
        line.copiedTitle = false;
        line.copiedText = false;
        buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist();
      }
    }

    // Copiar
    $("#copyAll").addEventListener("click", (e)=> {
      const approvedFAQ = history.faq.filter(f=>f.approved).map(f => {
        const cur = f.versions[f.vIdx]; return `P: ${cur.q}\nR: ${cur.a}`;
      }).join("\n\n");
      const cardsTxt = (history.cards||[]).map(c => `• ${c.title}: ${c.text}`).join("\n");
      const text = ["Título:", outTitle.value, "", "Descrição:", outDesc.value, "", "Cards:", cardsTxt, "", "Perguntas frequentes:", approvedFAQ].join("\n");
      navigator.clipboard.writeText(text);
      showCopyFeedback(e.currentTarget);
    });
    $("#copyTitle").addEventListener("click", (e)=> {
      navigator.clipboard.writeText(outTitle.value);
      showCopyFeedback(e.currentTarget);
    });
    $("#copyDesc").addEventListener("click", (e)=> {
      const approved = history.faq.filter(f=>f.approved).map(f=> f.versions[f.vIdx] );
      const lines = [outDesc.value];
      if(approved.length){ lines.push("", "Perguntas frequentes"); approved.forEach(x=>{ lines.push(`P: ${x.q}`); lines.push(`R: ${x.a}`); lines.push(""); }); }
      navigator.clipboard.writeText(lines.join("\n"));
      showCopyFeedback(e.currentTarget);
    });
    $("#copyDescNoFAQ").addEventListener("click", (e)=> {
      navigator.clipboard.writeText(outDesc.value || "");
      showCopyFeedback(e.currentTarget);
    });
    $("#copyFAQApproved").addEventListener("click", (e)=> {
      const faqApproved = history.faq.filter(f=>f.approved).map(f => {
        const cur = f.versions[f.vIdx]; return `P: ${cur.q}\nR: ${cur.a}`;
      }).join("\n\n");
      navigator.clipboard.writeText(faqApproved);
      showCopyFeedback(e.currentTarget);
    });

    // Geração principal
    async function generate(){
      // Resetar todo o histórico e interface quando gerar novo conteúdo
      resetHistory();
      
      statusArea.classList.remove("hidden"); loader.style.display="inline-block"; statusText.textContent="Gerando…";
      demoWarn.classList.add("hidden");
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      
      const req = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        options: {
          llm: llm.value,
          openai_api_key: (saved.openai || "").trim(),
          openai_base_url: (saved.openai_base || "").trim(),
          gemini_api_key: (saved.gemini || "").trim(),
          gemini_base_url: (saved.gemini_base || "").trim(),
          rules: saved.rules || {},
          prompt_template: saved.prompt_template || DEFAULT_PROMPT_TEMPLATE,
          tiny_product_data: tinyProductData || null
        }
      };
      
      // Preparar arquivos habilitados
      const enabledFiles = uploadedFiles.filter(f => f.enabled);
      
      try{
        let r, data;
        
        if(enabledFiles.length > 0){
          // Enviar com FormData se houver arquivos
          const formData = new FormData();
          formData.append('json_data', JSON.stringify(req));
          
          enabledFiles.forEach((item, index) => {
            formData.append('files', item.file);
          });
          
          r = await fetch("/api/generate", {method:"POST", body: formData});
        } else {
          // Enviar como JSON se não houver arquivos
          r = await fetch("/api/generate", {method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(req)});
        }
        
        data = await r.json();
        pushHistory("title", data.title || "");
        pushHistory("description", data.description || "");
        renderFAQ(data.faq || []); renderCards(data.cards || []);
        
        // Mostrar avisos sobre arquivos se houver
        if(data?.file_warnings && data.file_warnings.length > 0){
          demoWarn.classList.remove("hidden");
          demoText.innerHTML = `<strong>Avisos sobre arquivos:</strong><br>${data.file_warnings.join('<br>')}`;
        } else if(data?.sources_used?.mock){
          demoWarn.classList.remove("hidden");
          demoText.textContent = data?.sources_used?.message || "Modo demonstração: cadastre uma chave.";
        }
        
        // Mostrar quantos arquivos foram processados
        if(data?.files_processed){
          console.log(`✅ ${data.files_processed} arquivo(s) processado(s) com sucesso`);
        }
      } catch(err){
        alert("Erro ao gerar: " + (err?.message || String(err)));
      } finally{
        loader.style.display="none"; setTimeout(()=> statusArea.classList.add("hidden"), 800);
      }
    }

    // Listeners principais
    $("#btnGenerate").addEventListener("click", generate);
    $("#regenTitle").addEventListener("click", ()=> regenTitle(false));
    $("#regenTitlePrompt").addEventListener("click", ()=> regenTitle(true));
    $("#regenDesc").addEventListener("click", ()=> regenDesc(false));
    $("#regenDescPrompt").addEventListener("click", ()=> regenDesc(true));
    titlePrev.addEventListener("click", ()=> navHistory("title",-1));
    titleNext.addEventListener("click", ()=> navHistory("title",+1));
    descPrev.addEventListener("click", ()=> navHistory("description",-1));
    descNext.addEventListener("click", ()=> navHistory("description",+1));

    restoreState();
    updateTinyInstanceSelect();
    renderWholesaleTable();
  </script>
</body>
</html>
