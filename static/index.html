<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ads Generator ‚Äî Gerador de An√∫ncios Multi-Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --indigo-600:#4f46e5; --indigo-700:#4338ca; --bg:#f3f4f6; --card:#ffffff; }
    body { font-family:'Inter',sans-serif; background:var(--bg); }
    .card { background:var(--card); border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:.45rem .7rem; border-radius:.5rem; background:white; color:#374151; border:1px solid #e5e7eb; }
    .btn:hover{ background:#f9fafb; }
    .icon { width:18px; height:18px; stroke:#4b5563; fill:none; }
    .icon-fill { width:18px; height:18px; stroke:#4b5563; fill:#4b5563; }
    .loader { width:22px; height:22px; border-radius:9999px; border:3px solid #e5e7eb; border-top-color:#6b7280; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal { position:fixed; inset:0; background:rgba(15,23,42,.28); display:none; align-items:center; justify-content:center; padding:1.25rem; z-index:50; }
    .modal.open { display:flex; }
    .modal-card { width:100%; max-width:44rem; }
    .muted { color:#6b7280 }
    .badge { padding:.125rem .5rem; font-size:.75rem; border:1px solid #e5e7eb; border-radius:9999px; }
    .subctrl { display:flex; align-items:center; gap:.5rem; font-size:.8rem; color:#4b5563; }
    .pulse { animation: pulse 1s ease-in-out infinite; }
    @keyframes pulse { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
    .toolbar { display:flex; align-items:center; gap:.5rem; }
    .toolbar .grow { flex:1 1 auto; }
    .floating-right { margin-left:auto; display:flex; gap:.5rem; }
    .label-row { display:flex; align-items:center; justify-content:space-between; }
    .floating-tts { position:fixed; top:1rem; left:50%; transform:translateX(-50%); background:white; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.1); padding:1rem; z-index:40; display:none; max-width:90vw; }
    .floating-tts.show { display:block; animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { opacity:0; transform:translateX(-50%) translateY(-20px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }
    .floating-tts .controls { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .floating-tts .label { font-size:.75rem; font-weight:600; color:#6b7280; margin-right:.5rem; }
    .tts-active { background:#4f46e5 !important; color:white !important; }
    .tts-active svg { stroke:white !important; }
    .tts-highlight { background:#dbeafe; color:#1e40af; font-weight:600; border-radius:.25rem; padding:0 .125rem; transition:all .1s; }
    .mono { font-family:monospace; }
  </style>
</head>
<body class="min-h-screen">
  <main class="w-full max-w-5xl mx-auto p-4 grid gap-6">
    <section class="card p-5">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-2xl font-semibold text-gray-900">Ads Generator ‚Äî Gerador de An√∫ncios Multi-Marketplace</h1>
          <p class="text-sm text-gray-600 mt-1">Python ‚Ä¢ FastAPI ‚Ä¢ OpenAI/Gemini</p>
        </div>
        <div class="flex gap-2">
          <button id="btnConfig" class="btn" title="Configurar">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8zm8 4a8 8 0 01-.32 2.24l2.06 1.6-2 3.46-2.45-1a8.06 8.06 0 01-1.93 1.12l-.37 2.62h-4l-.37-2.62A8.06 8.06 0 017.7 20.3l-2.45 1-2-3.46 2.06-1.6A7.93 7.93 0 015 12a7.93 7.93 0 01.32-2.24L3.26 8.16l2-3.46 2.45 1A8.06 8.06 0 019.64 4.6L10 2h4l.37 2.62a8.06 8.06 0 011.93 1.12l2.45-1 2 3.46-2.06 1.6A8 8 0 0120 12z" stroke-width="1.5"/></svg>
          </button>
        </div>
      </div>

      <div class="mt-4 grid sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-700 font-medium">Produto</label>
          <input id="productName" type="text" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex.: Tapete higi√™nico 80x60 lavanda">
        </div>
        <div>
          <label class="text-sm text-gray-700 font-medium">Marketplace</label>
          <select id="marketplace" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="mercadolivre">Mercado Livre</option>
            <option value="shopee">Shopee</option>
            <option value="amazon">Amazon</option>
            <option value="magalu">Magalu</option>
            <option value="shein">Shein</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-700 font-medium">LLM</label>
          <select id="llm" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="openai">OpenAI</option>
            <option value="gemini">Google Gemini</option>
          </select>
        </div>
        <div class="flex items-end">
          <!-- Azul padr√£o em todos os bot√µes principais -->
          <button id="btnGenerate" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700 w-full"><span class="mr-2">‚ö°</span>Gerar conte√∫do</button>
        </div>
      </div>

      <div id="statusArea" class="mt-4 hidden">
        <div class="flex items-center gap-3 text-sm text-gray-700">
          <div class="loader" id="loader" aria-hidden="true"></div>
          <span id="statusText">Gerando‚Ä¶</span>
        </div>
      </div>

      <div id="demoWarn" class="mt-4 hidden">
        <div class="rounded-md border border-yellow-200 bg-yellow-50 p-3 text-sm text-yellow-800" id="demoText"></div>
      </div>
    </section>

    <!-- Leitor (TTS) -->
    <section class="card p-5" id="ttsSection">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Leitura em voz alta</h2>
        <div class="flex items-center gap-2" id="ttsControls">
          <button id="ttsPlay" class="btn" title="Play"><svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" stroke-width="1.5"/></svg></button>
          <button id="ttsPrev" class="btn" title="Anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M11 6l-7 6 7 6V6zM20 5v14" stroke-width="1.5"/></svg></button>
          <button id="ttsNext" class="btn" title="Pr√≥ximo"><svg class="icon" viewBox="0 0 24 24"><path d="M13 6l7 6-7 6V6zM4 5v14" stroke-width="1.5"/></svg></button>
          <button id="ttsPause" class="btn" title="Pausar"><svg class="icon" viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z" stroke-width="1.5"/></svg></button>
          <button id="ttsStop" class="btn" title="Parar"><svg class="icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z" stroke-width="1.5"/></svg></button>
          <button id="ttsRate" class="btn" title="Velocidade">1x</button>
        </div>
      </div>
      <p class="text-sm text-gray-600 mt-2">Ordem: <b>T√≠tulo</b> ‚Üí <b>Descri√ß√£o</b> ‚Üí <b>FAQ (aprovada)</b> ‚Üí <b>Cards</b>. <span class="badge muted" id="ttsAuto">Autoplay ON</span></p>
      <div id="ttsNow" class="text-sm text-gray-700 mt-2"></div>
    </section>

    <section class="card p-5" id="resultCard">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Resultado</h2>
        <div class="flex gap-2">
          <button id="copyAll" class="btn" title="Copiar tudo"><svg class="icon" viewBox="0 0 24 24"><path d="M9 9h11v11H9zM4 4h11v11H4z" stroke-width="1.5"/></svg></button>
        </div>
      </div>

      <!-- T√≠tulo -->
      <div class="mt-4">
        <div class="label-row">
          <h3 class="font-medium text-gray-700 mt-1">T√≠tulo</h3>
          <div class="toolbar">
            <div class="grow"></div>
            <button id="titlePrev" class="btn hidden" title="Vers√£o anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
            <span id="titleCount" class="muted hidden">1/1</span>
            <button id="titleNext" class="btn hidden" title="Pr√≥xima vers√£o"><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
            <button id="regenTitle" class="btn" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
            <button id="regenTitlePrompt" class="btn" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
            <button id="copyTitle" class="btn" title="Copiar t√≠tulo"><svg class="icon" viewBox="0 0 24 24"><path d="M9 9h11v11H9zM4 4h11v11H4z" stroke-width="1.5"/></svg></button>
          </div>
        </div>
        <textarea id="outTitle" rows="2" class="mt-2 w-full mono rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"></textarea>
      </div>

      <!-- Descri√ß√£o -->
      <div class="mt-6">
        <div class="label-row">
          <h3 class="font-medium text-gray-700 mt-1">Descri√ß√£o</h3>
        </div>
        <div class="toolbar mt-1">
          <div class="grow"></div>
          <button id="descPrev" class="btn hidden" title="Vers√£o anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
          <span id="descCount" class="muted hidden">1/1</span>
          <button id="descNext" class="btn hidden" title="Pr√≥xima vers√£o"><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
          <button id="regenDesc" class="btn" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
          <button id="regenDescPrompt" class="btn" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
          <button id="copyDesc" class="btn" title="Copiar descri√ß√£o (com FAQ)"><svg class="icon-fill" viewBox="0 0 24 24"><path d="M9 9h11v11H9z"/><path d="M4 4h11v11H4z"/></svg></button>
          <button id="copyDescNoFAQ" class="btn" title="Copiar descri√ß√£o (sem FAQ)"><svg class="icon" viewBox="0 0 24 24"><path d="M9 9h11v11H9zM4 4h11v11H4z" stroke-width="1.5"/></svg></button>
        </div>
        <textarea id="outDesc" rows="10" class="mt-2 w-full mono rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"></textarea>
      </div>

      <!-- FAQ -->
      <div class="mt-6">
        <div class="label-row">
          <h3 class="font-medium text-gray-700">FAQ</h3>
          <div class="toolbar">
            <button id="copyFAQApproved" class="btn" title="Copiar FAQ aprovada"><svg class="icon" viewBox="0 0 24 24"><path d="M9 9h11v11H9zM4 4h11v11H4z" stroke-width="1.5"/></svg></button>
          </div>
        </div>
        <div id="faqList" class="mt-2 grid gap-2"></div>
      </div>

      <!-- Cards -->
      <div class="mt-6">
        <h3 class="font-medium text-gray-700">Cards</h3>
        <div id="cardsList" class="mt-2 grid gap-3"></div>
      </div>
    </section>
  </main>

  <!-- Controles TTS Flutuantes -->
  <div id="floatingTTS" class="floating-tts">
    <div class="controls">
      <span class="label">üîä Leitura</span>
      <button id="ttsPlayFloat" class="btn" title="Play"><svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" stroke-width="1.5"/></svg></button>
      <button id="ttsPrevFloat" class="btn" title="Anterior"><svg class="icon" viewBox="0 0 24 24"><path d="M11 6l-7 6 7 6V6zM20 5v14" stroke-width="1.5"/></svg></button>
      <button id="ttsNextFloat" class="btn" title="Pr√≥ximo"><svg class="icon" viewBox="0 0 24 24"><path d="M13 6l7 6-7 6V6zM4 5v14" stroke-width="1.5"/></svg></button>
      <button id="ttsPauseFloat" class="btn" title="Pausar"><svg class="icon" viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z" stroke-width="1.5"/></svg></button>
      <button id="ttsStopFloat" class="btn" title="Parar"><svg class="icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z" stroke-width="1.5"/></svg></button>
      <button id="ttsRateFloat" class="btn" title="Velocidade">1x</button>
    </div>
  </div>

  <!-- Modal Prompt -->
  <div id="promptModal" class="modal">
    <div class="modal-card card p-5">
      <h3 id="promptTitle" class="text-lg font-semibold text-gray-800">Instru√ß√µes adicionais</h3>
      <textarea id="promptText" rows="6" class="mt-2 w-full mono rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder="Descreva o que ajustar, corrigir ou detalhar..."></textarea>
      <div class="mt-3 flex justify-end gap-2">
        <button id="promptCancel" class="btn">Cancelar</button>
        <button id="promptOk" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- Modal Config -->
  <div id="configModal" class="modal">
    <div class="modal-card card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">Configura√ß√µes</h3>
        <button id="cfgClose" class="btn" title="Fechar">Fechar</button>
      </div>

      <div class="grid sm:grid-cols-2 gap-4 mt-3">
        <div>
          <label class="text-sm text-gray-700 font-medium">OpenAI API Key</label>
          <input id="cfgOpenAI" type="password" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
        </div>
        <div>
          <label class="text-sm text-gray-700 font-medium">OpenAI Base URL (opcional)</label>
          <input id="cfgOpenAIBase" type="text" placeholder="https://api.openai.com/v1" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
        </div>
        <div>
          <label class="text-sm text-gray-700 font-medium">Gemini API Key</label>
          <input id="cfgGemini" type="password" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
        </div>
        <div>
          <label class="text-sm text-gray-700 font-medium">Gemini Base URL (opcional)</label>
          <input id="cfgGeminiBase" type="text" placeholder="https://generativelanguage.googleapis.com" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
        </div>
      </div>

      <div class="mt-4">
        <label class="text-sm text-gray-700 font-medium">RuleSets (JSON por marketplace)</label>
        <textarea id="cfgRules" rows="8" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm" placeholder='{"mercadolivre":{"title_max_chars":60}}'></textarea>
      </div>

      <div class="mt-4">
        <label class="text-sm text-gray-700 font-medium">Prompt Template</label>
        <textarea id="cfgPromptTpl" rows="12" class="mt-1 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm"
          placeholder='Use {product}, {marketplace} e {specs}. As demais chaves {{ }} do JSON podem ficar sem escape.'></textarea>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="cfgCancel" class="btn">Cancelar</button>
        <button id="cfgSave" class="px-3 py-1.5 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    function $(q){ return document.querySelector(q); }
    const LS_KEY = "adsgen_settings_v2";
    const LS_STATE = "adsgen_state_v3";
    const LS_TTS_RATE = "adsgen_tts_rate";

    const productName = $("#productName"), marketplace=$("#marketplace"), llm=$("#llm");
    const btnGenerate=$("#btnGenerate");
    const outTitle=$("#outTitle"), outDesc=$("#outDesc");
    const faqList=$("#faqList"), cardsList=$("#cardsList");
    const statusArea=$("#statusArea"), statusText=$("#statusText"), loader=$("#loader");
    const demoWarn=$("#demoWarn"), demoText=$("#demoText");

    const titlePrev=$("#titlePrev"), titleNext=$("#titleNext"), titleCount=$("#titleCount");
    const descPrev=$("#descPrev"), descNext=$("#descNext"), descCount=$("#descCount");

    // Controles TTS Flutuantes
    const ttsSection = $("#ttsSection");
    const floatingTTS = $("#floatingTTS");
    const ttsPlayFloat = $("#ttsPlayFloat");
    const ttsPrevFloat = $("#ttsPrevFloat");
    const ttsNextFloat = $("#ttsNextFloat");
    const ttsPauseFloat = $("#ttsPauseFloat");
    const ttsStopFloat = $("#ttsStopFloat");
    const ttsRateFloat = $("#ttsRateFloat");

    // Observador de Interse√ß√£o para mostrar/esconder controles flutuantes
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          floatingTTS.classList.remove("show");
        } else {
          floatingTTS.classList.add("show");
        }
      });
    }, { threshold: 0.1 });

    if (ttsSection) observer.observe(ttsSection);

    // Sincronizar bot√µes flutuantes com originais
    ttsPlayFloat.addEventListener("click", () => $("#ttsPlay").click());
    ttsPrevFloat.addEventListener("click", () => $("#ttsPrev").click());
    ttsNextFloat.addEventListener("click", () => $("#ttsNext").click());
    ttsPauseFloat.addEventListener("click", () => $("#ttsPause").click());
    ttsStopFloat.addEventListener("click", () => $("#ttsStop").click());
    ttsRateFloat.addEventListener("click", () => $("#ttsRate").click());

    // Prompt Modal
    const promptModal=$("#promptModal"); const promptTitleEl=$("#promptTitle"); const promptTextEl=$("#promptText");
    const promptOk=$("#promptOk"); const promptCancel=$("#promptCancel"); let promptResolve=null;
    function openPrompt(title){ promptTitleEl.textContent=title||"Instru√ß√µes adicionais"; promptTextEl.value=""; promptModal.classList.add("open"); return new Promise(res=>{promptResolve=res}); }
    promptCancel.addEventListener("click", ()=>{ promptModal.classList.remove("open"); if(promptResolve) promptResolve(null); });
    promptOk.addEventListener("click", ()=>{ promptModal.classList.remove("open"); if(promptResolve) promptResolve(promptTextEl.value); });

    // Config Modal
    const cfgModal = $("#configModal"); const btnConfig = $("#btnConfig");
    const cfgOpenAI=$("#cfgOpenAI"), cfgOpenAIBase=$("#cfgOpenAIBase");
    const cfgGemini=$("#cfgGemini"), cfgGeminiBase=$("#cfgGeminiBase");
    const cfgRules=$("#cfgRules"), cfgPromptTpl=$("#cfgPromptTpl");
    const cfgSave=$("#cfgSave"), cfgCancel=$("#cfgCancel"), cfgClose=$("#cfgClose");

    const DEFAULT_PROMPT_TEMPLATE =
`Produto: "{product}"
Marketplace: {marketplace}
Especifica√ß√µes agregadas (parciais e possivelmente ruidosas): {specs}

Tarefas:
1) T√çTULO (apenas texto, 1 linha) ‚Äî incluir marca, atributo-chave e variante quando relevante.
2) DESCRI√á√ÉO (sem emojis; clara, escane√°vel; 3-6 bullets iniciais + 3-5 par√°grafos).
3) FAQ (10 pares Q->A) ‚Äì foque obje√ß√µes reais, uso, compatibilidades, garantia, manuten√ß√£o, devolu√ß√£o.
4) CARDS (11 itens) ‚Äì para imagens 1200x1200: cada item = { "title": "...", "text": "..." } curto e direto.

Restri√ß√µes:
- Sem ‚Äúfrete gr√°tis‚Äù, ‚Äúbrinde‚Äù, ‚Äúpromo√ß√£o‚Äù ou equivalentes.
- N√£o use emojis. Escreva em portugu√™s do Brasil.
- Adapte o tom ao marketplace especificado.
- Responda em JSON com as chaves: title, description, faq (array de objetos {q,a}), cards (array de objetos {title,text}).
`;

    btnConfig.addEventListener("click", ()=> {
      const saved = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      cfgOpenAI.value = saved.openai || "";
      cfgOpenAIBase.value = saved.openai_base || "";
      cfgGemini.value = saved.gemini || "";
      cfgGeminiBase.value = saved.gemini_base || "";
      cfgRules.value = saved.rules ? JSON.stringify(saved.rules, null, 2) : "";
      cfgPromptTpl.value = saved.prompt_template || DEFAULT_PROMPT_TEMPLATE;
      cfgModal.classList.add("open");
    });
    function closeCfg(){ cfgModal.classList.remove("open"); }
    cfgCancel.addEventListener("click", closeCfg);
    cfgClose.addEventListener("click", closeCfg);
    cfgSave.addEventListener("click", ()=> {
      let rules = {};
      if (cfgRules.value.trim()) {
        try { rules = JSON.parse(cfgRules.value); } catch(e){ alert("RuleSets inv√°lido (JSON). Corrija e tente novamente."); return; }
      }
      const payload = {
        openai: cfgOpenAI.value.trim(),
        openai_base: cfgOpenAIBase.value.trim(),
        gemini: cfgGemini.value.trim(),
        gemini_base: cfgGeminiBase.value.trim(),
        rules,
        prompt_template: cfgPromptTpl.value
      };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
      closeCfg();
    });

    // -------- Estado / Hist√≥rico --------
    const history = { title:[], titleIdx:-1, description:[], descIdx:-1, faq:[], cards:[], cardLines:[] };
    function persistState(){ localStorage.setItem(LS_STATE, JSON.stringify(history)); }
    function restoreState(){
      try{
        const st = JSON.parse(localStorage.getItem(LS_STATE)||"null");
        if(!st) return;
        Object.assign(history, st);
        if(history.titleIdx>=0) outTitle.value = history.title[history.titleIdx];
        if(history.descIdx>=0) outDesc.value = history.description[history.descIdx];
        renderFAQFromState(); renderCardsFromState(); updateVersionControls(); rebuildPlaylist();
      }catch(e){}
    }
    function resetHistory(){
      // Limpar hist√≥rico
      history.title = [];
      history.titleIdx = -1;
      history.description = [];
      history.descIdx = -1;
      history.faq = [];
      history.cards = [];
      history.cardLines = [];
      
      // Limpar interface
      outTitle.value = "";
      outDesc.value = "";
      faqList.innerHTML = "";
      cardsList.innerHTML = "";
      
      // Limpar controles de vers√£o
      updateVersionControls();
      
      // Limpar playlist TTS
      rebuildPlaylist();
      
      // Persistir estado limpo
      persistState();
    }
    function pushHistory(key, value){
      if(key==="title"){
        history.title = history.title.slice(0, history.titleIdx+1);
        history.title.push(value); history.titleIdx = history.title.length-1; outTitle.value=value;
      }else if(key==="description"){
        history.description = history.description.slice(0, history.descIdx+1);
        history.description.push(value); history.descIdx = history.description.length-1; outDesc.value=value;
      }
      persistState(); updateVersionControls(); rebuildPlaylist();
    }
    function navHistory(key, dir){
      if(key==="title"){
        const next = history.titleIdx + dir;
        if(next>=0 && next<history.title.length){ history.titleIdx=next; outTitle.value=history.title[next]; }
      }else if(key==="description"){
        const next = history.descIdx + dir;
        if(next>=0 && next<history.description.length){ history.descIdx=next; outDesc.value=history.description[next]; }
      }
      persistState(); updateVersionControls(); rebuildPlaylist();
    }
    function updateVersionControls(){
      const tCount = history.title.length, tIdx = history.titleIdx;
      const dCount = history.description.length, dIdx = history.descIdx;
      titlePrev.classList.toggle("hidden", !(tCount>1 && tIdx>0));
      titleNext.classList.toggle("hidden", !(tCount>1 && tIdx<tCount-1));
      titleCount.classList.toggle("hidden", !(tCount>1));
      if(tCount>1) titleCount.textContent = `${tIdx+1}/${tCount}`;
      descPrev.classList.toggle("hidden", !(dCount>1 && dIdx>0));
      descNext.classList.toggle("hidden", !(dCount>1 && dIdx<dCount-1));
      descCount.classList.toggle("hidden", !(dCount>1));
      if(dCount>1) descCount.textContent = `${dIdx+1}/${dCount}`;
    }

    // -------- FAQ --------
    function renderFAQ(items){
      history.faq = (items||[]).map(x=>({ approved:true, versions:[{q:x.q,a:x.a}], vIdx:0 }));
      renderFAQFromState();
    }
    function renderFAQFromState(){
      faqList.innerHTML = "";
      history.faq.forEach((line, idx)=>{
        const cur = line.versions[line.vIdx];
        const el = document.createElement("div");
        el.className = "relative rounded-md p-3 text-sm bg-white border " + (line.approved ? "border-gray-200" : "border-red-400");
        el.innerHTML = `
          <div class="label-row mb-1">
            <div class="toolbar">
              <button class="btn" data-action="prev" title="Vers√£o anterior" ${line.vIdx>0?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
              <span class="muted" data-role="count" ${line.versions.length>1?"":"style='display:none'"}>${line.vIdx+1}/${line.versions.length}</span>
              <button class="btn" data-action="next" title="Pr√≥xima vers√£o" ${(line.vIdx<line.versions.length-1)?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="regen" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="prompt" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="approve" title="${line.approved ? 'Desabilitar FAQ' : 'Habilitar FAQ'}">
                ${line.approved 
                  ? '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l3 3 5-6" stroke-width="1.5"/></svg>'
                  : '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M15 9l-6 6M9 9l6 6" stroke-width="1.5"/></svg>'
                }
              </button>
            </div>
            <div class="floating-right">
              <button class="btn" data-action="copy" title="Copiar item"><svg class="icon" viewBox="0 0 24 24"><path d="M9 9h11v11H9zM4 4h11v11H4z" stroke-width="1.5"/></svg></button>
            </div>
          </div>
          <div class="font-medium text-gray-800">P: <span class="q"></span></div>
          <div class="text-gray-700 mt-1">R: <span class="a"></span></div>
        `;
        const qEl = el.querySelector(".q"), aEl = el.querySelector(".a");
        qEl.textContent = cur.q; aEl.textContent = cur.a;

        function setProcessing(on){
          if(on){ qEl.parentElement.classList.add("pulse"); aEl.parentElement.classList.add("pulse"); }
          else{ qEl.parentElement.classList.remove("pulse"); aEl.parentElement.classList.remove("pulse"); }
        }

        const prevBtn = el.querySelector('[data-action="prev"]');
        if(prevBtn) prevBtn.addEventListener("click", ()=>{ if(line.vIdx>0){ line.vIdx--; renderFAQFromState(); persistState(); rebuildPlaylist(); } });
        const nextBtn = el.querySelector('[data-action="next"]');
        if(nextBtn) nextBtn.addEventListener("click", ()=>{ if(line.vIdx<line.versions.length-1){ line.vIdx++; renderFAQFromState(); persistState(); rebuildPlaylist(); } });

        el.querySelector('[data-action="copy"]').addEventListener("click", ()=> {
          navigator.clipboard.writeText(`P: ${cur.q}\nR: ${cur.a}`);
        });
        el.querySelector('[data-action="approve"]').addEventListener("click", ()=> {
          line.approved = !line.approved;
          el.className = "relative rounded-md p-3 text-sm bg-white border " + (line.approved ? "border-gray-200" : "border-red-400");
          persistState(); rebuildPlaylist();
        });
        el.querySelector('[data-action="regen"]').addEventListener("click", async ()=>{ setProcessing(true); await regenFAQ(idx); setProcessing(false); });
        el.querySelector('[data-action="prompt"]').addEventListener("click", async ()=>{ const txt = await openPrompt("Instru√ß√µes para regerar esta FAQ:"); if(txt!==null){ setProcessing(true); await regenFAQ(idx, txt); setProcessing(false); } });

        faqList.appendChild(el);
      });
      persistState(); rebuildPlaylist();
    }

    // -------- Cards --------
    function renderCards(items){
      history.cardLines = (items||[]).map(x=>({ versions:[{title:x.title||"", text:x.text||""}], vIdx:0, copiedTitle: false, copiedText: false }));
      buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist();
    }
    function buildCurrentCards(){ history.cards = history.cardLines.map(l => l.versions[l.vIdx]); }
    function renderCardsFromState(){
      cardsList.innerHTML = "";
      history.cardLines.forEach((line, idx)=>{
        const cur = line.versions[line.vIdx];
        const el = document.createElement("div");
        
        // Determinar cor da borda baseado no estado de c√≥pia
        let borderClass = "border-gray-200";
        const copiedCount = (line.copiedTitle ? 1 : 0) + (line.copiedText ? 1 : 0);
        if (copiedCount === 1) borderClass = "border-yellow-400";
        else if (copiedCount === 2) borderClass = "border-green-400";
        
        el.className = `relative border ${borderClass} rounded-md p-3 text-sm bg-white`;
        el.innerHTML = `
          <div class="label-row mb-1">
            <div class="toolbar">
              <button class="btn" data-action="prev" title="Vers√£o anterior" ${line.vIdx>0?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M15 6l-7 6 7 6" stroke-width="1.5"/></svg></button>
              <span class="muted" data-role="count" ${line.versions.length>1?"":"style='display:none'"}>${line.vIdx+1}/${line.versions.length}</span>
              <button class="btn" data-action="next" title="Pr√≥xima vers√£o" ${(line.vIdx<line.versions.length-1)?"":"style='display:none'"}><svg class="icon" viewBox="0 0 24 24"><path d="M9 6l7 6-7 6" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="regen" title="Regerar"><svg class="icon" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" stroke-width="1.5"/></svg></button>
              <button class="btn" data-action="prompt" title="Regerar com prompt"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4-9 9H7.5v-4z" stroke-width="1.5"/></svg></button>
            </div>
            <div class="floating-right"></div>
          </div>
          <div class="font-medium text-gray-800 flex items-center justify-between">
            <span><b>T√≠tulo:</b> <span class="ctitle"></span></span>
            <button class="btn" data-action="copyTitle" title="Copiar t√≠tulo">
              ${line.copiedTitle 
                ? '<svg class="icon-fill" viewBox="0 0 24 24"><path d="M9 9h11v11H9z"/><path d="M4 4h11v11H4z"/></svg>'
                : '<svg class="icon" viewBox="0 0 24 24"><path d="M9 9h11v11H9zM4 4h11v11H4z" stroke-width="1.5"/></svg>'
              }
            </button>
          </div>
          <div class="text-gray-700 flex items-center justify-between mt-1">
            <span><b>Texto:</b> <span class="ctext"></span></span>
            <button class="btn" data-action="copyText" title="Copiar texto">
              ${line.copiedText
                ? '<svg class="icon-fill" viewBox="0 0 24 24"><path d="M9 9h11v11H9z"/><path d="M4 4h11v11H4z"/></svg>'
                : '<svg class="icon" viewBox="0 0 24 24"><path d="M9 9h11v11H9zM4 4h11v11H4z" stroke-width="1.5"/></svg>'
              }
            </button>
          </div>
        `;
        const tEl = el.querySelector(".ctitle"), xEl = el.querySelector(".ctext");
        tEl.textContent = cur.title; xEl.textContent = cur.text;

        function setProcessing(on){
          if(on){ tEl.parentElement.classList.add("pulse"); xEl.parentElement.classList.add("pulse"); }
          else { tEl.parentElement.classList.remove("pulse"); xEl.parentElement.classList.remove("pulse"); }
        }

        const prevBtn = el.querySelector('[data-action="prev"]');
        if(prevBtn) prevBtn.addEventListener("click", ()=>{ 
          if(line.vIdx>0){ 
            line.vIdx--; 
            line.copiedTitle = false;
            line.copiedText = false;
            buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist(); 
          } 
        });
        const nextBtn = el.querySelector('[data-action="next"]');
        if(nextBtn) nextBtn.addEventListener("click", ()=>{ 
          if(line.vIdx<line.versions.length-1){ 
            line.vIdx++; 
            line.copiedTitle = false;
            line.copiedText = false;
            buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist(); 
          } 
        });
        el.querySelector('[data-action="regen"]').addEventListener("click", async ()=>{ setProcessing(true); await regenCard(idx); setProcessing(false); });
        el.querySelector('[data-action="prompt"]').addEventListener("click", async ()=>{ const txt = await openPrompt("Instru√ß√µes para regerar este card:"); if(txt!==null){ setProcessing(true); await regenCard(idx, txt); setProcessing(false); } });

        el.querySelector('[data-action="copyTitle"]').addEventListener("click", ()=> {
          navigator.clipboard.writeText(cur.title||"");
          line.copiedTitle = true;
          renderCardsFromState();
          persistState();
        });
        el.querySelector('[data-action="copyText"]').addEventListener("click", ()=> {
          navigator.clipboard.writeText(cur.text||"");
          line.copiedText = true;
          renderCardsFromState();
          persistState();
        });

        cardsList.appendChild(el);
      });
    }

    // -------- TTS / Playlist --------
    let playlist = []; let curIdx = -1; let autoplay = true; let rate = parseFloat(localStorage.getItem(LS_TTS_RATE) || "1") || 1;
    let isPaused = false;
    const ttsNow = $("#ttsNow"); const ttsAuto = $("#ttsAuto"); const ttsRateBtn = $("#ttsRate");
    ttsRateBtn.textContent = rate+"x";
    ttsRateFloat.textContent = rate+"x";

    function rebuildPlaylist(){
      // Salvar o item atual antes de reconstruir
      const currentItem = (curIdx >= 0 && curIdx < playlist.length) ? playlist[curIdx] : null;
      
      playlist = [];
      if(outTitle.value.trim()) playlist.push({label:"T√≠tulo", text: outTitle.value.trim(), element: outTitle, type: "field"});
      if(outDesc.value.trim()) playlist.push({label:"Descri√ß√£o", text: outDesc.value.trim(), element: outDesc, type: "field"});
      
      // Para FAQ, guardar o √≠ndice original no array history.faq (n√£o o √≠ndice no array filtrado)
      history.faq.forEach((f, originalIdx) => {
        if(f.approved){
          const cur = f.versions[f.vIdx];
          const approvedIdx = history.faq.slice(0, originalIdx).filter(x => x.approved).length;
          playlist.push({
            label:`FAQ ${approvedIdx+1}`, 
            text:`Pergunta: ${cur.q}. Resposta: ${cur.a}.`, 
            type: "faq", 
            index: approvedIdx,
            originalIndex: originalIdx  // √çndice real no array history.faq
          });
        }
      });
      
      // Para Cards, guardar o √≠ndice original tamb√©m
      (history.cards||[]).forEach((c,i)=> playlist.push({
        label:`Card ${i+1}`, 
        text:`${c.title}. ${c.text}`, 
        type: "card", 
        index: i,
        originalIndex: i
      }));
      
      // Tentar manter o mesmo item l√≥gico ap√≥s reconstruir usando originalIndex
      if(currentItem){
        const newIdx = playlist.findIndex(item => {
          if(item.type !== currentItem.type) return false;
          
          // Para FAQ e Card, usar originalIndex para identifica√ß√£o precisa
          if(item.type === "faq" || item.type === "card"){
            // Tentar por originalIndex primeiro
            if(currentItem.originalIndex !== undefined && item.originalIndex === currentItem.originalIndex){
              return true;
            }
            // Fallback para compatibilidade: comparar por texto se originalIndex n√£o existe
            if(currentItem.originalIndex === undefined){
              return item.text === currentItem.text;
            }
            return false;
          }
          
          // Para outros tipos (t√≠tulo, descri√ß√£o), usar label e texto
          return item.label === currentItem.label && item.text === currentItem.text;
        });
        
        if(newIdx >= 0){
          curIdx = newIdx; // Encontrou o mesmo item
        } else {
          // Item n√£o existe mais, ajustar para o mais pr√≥ximo
          curIdx = Math.min(curIdx, playlist.length - 1);
        }
      }
      
      if(curIdx >= playlist.length) curIdx = playlist.length - 1;
      if(curIdx === -1 && playlist.length) curIdx = 0;
    }
    let currentHighlightElement = null;
    let originalContent = "";
    
    function clearHighlight(){
      if(currentHighlightElement){
        if(currentHighlightElement.tagName === "TEXTAREA" || currentHighlightElement.tagName === "INPUT"){
          // Remover sele√ß√£o dos campos de texto
          currentHighlightElement.setSelectionRange(0, 0);
          currentHighlightElement.blur();
        } else {
          currentHighlightElement.innerHTML = originalContent;
        }
        currentHighlightElement = null;
        originalContent = "";
      }
    }
    
    function speakCurrent(){
      if(curIdx < 0 || curIdx >= playlist.length) return;
      clearHighlight();
      
      const part = playlist[curIdx];
      ttsNow.textContent = `Lendo: ${part.label} (${rate}x)`;
      window.speechSynthesis.cancel();
      isPaused = false;
      
      const utter = new SpeechSynthesisUtterance(part.text);
      utter.lang = "pt-BR"; utter.rate = rate;
      
      // Dividir texto em palavras para highlight
      const words = part.text.split(/(\s+)/); // Mant√©m os espa√ßos
      let currentWordIndex = 0;
      
      // Scroll para o elemento atual
      if(part.element){
        part.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        currentHighlightElement = part.element;
      } else if(part.type === "faq"){
        const faqElements = faqList.querySelectorAll('.relative');
        const faqIndex = part.originalIndex !== undefined ? part.originalIndex : part.index;
        if(faqElements[faqIndex]){
          faqElements[faqIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } else if(part.type === "card"){
        const cardElements = cardsList.querySelectorAll('.relative');
        const cardIndex = part.originalIndex !== undefined ? part.originalIndex : part.index;
        if(cardElements[cardIndex]){
          cardElements[cardIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
      
      utter.onboundary = (event) => {
        if(event.name === 'word'){
          const wordStart = event.charIndex;
          const wordEnd = event.charIndex + event.charLength;
          
          // Aplicar highlight se for um campo de texto (usando sele√ß√£o nativa)
          if(part.element && (part.element.tagName === "TEXTAREA" || part.element.tagName === "INPUT")){
            part.element.focus();
            part.element.setSelectionRange(wordStart, wordEnd);
            
            // Auto-scroll do campo para mostrar a sele√ß√£o
            if(part.element.tagName === "TEXTAREA"){
              // Usar t√©cnica de medi√ß√£o real da posi√ß√£o do cursor
              const textareaStyle = getComputedStyle(part.element);
              const lineHeight = parseFloat(textareaStyle.lineHeight) || 20;
              
              // Criar elemento tempor√°rio para medir posi√ß√£o real do texto
              const mirror = document.createElement('div');
              mirror.style.cssText = `
                position: absolute;
                visibility: hidden;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-wrap: break-word;
                width: ${part.element.clientWidth - parseFloat(textareaStyle.paddingLeft) - parseFloat(textareaStyle.paddingRight)}px;
                font: ${textareaStyle.font};
                padding: ${textareaStyle.padding};
                border: ${textareaStyle.border};
                line-height: ${textareaStyle.lineHeight};
              `;
              
              // Adicionar texto at√© o cursor
              mirror.textContent = part.element.value.substring(0, wordStart);
              document.body.appendChild(mirror);
              
              // Medir altura real
              const cursorHeight = mirror.offsetHeight;
              document.body.removeChild(mirror);
              
              // Calcular scroll ideal para centralizar
              const visibleHeight = part.element.clientHeight;
              const idealScrollTop = cursorHeight - (visibleHeight / 2) + (lineHeight / 2);
              
              // Aplicar scroll
              part.element.scrollTop = Math.max(0, idealScrollTop);
            }
          } else if(part.type === "faq" || part.type === "card"){
            // Para FAQ e Cards, destacar a palavra no elemento de texto
            const containerList = part.type === "faq" ? faqList : cardsList;
            const items = containerList.querySelectorAll('.relative');
            // Usar originalIndex para encontrar o elemento correto (items cont√©m todos, n√£o s√≥ aprovados)
            const itemIndex = part.originalIndex !== undefined ? part.originalIndex : part.index;
            if(items[itemIndex]){
              let targetSpan = null;
              let localStart = wordStart;
              let localEnd = wordEnd;
              
              if(part.type === "faq"){
                const qSpan = items[itemIndex].querySelector('.q');
                const aSpan = items[itemIndex].querySelector('.a');
                const qPrefix = "Pergunta: ";
                const qText = qSpan ? qSpan.textContent : "";
                const aSeparator = ". Resposta: ";
                const aText = aSpan ? aSpan.textContent : "";
                
                const qEnd = qPrefix.length + qText.length;
                const aStart = qEnd + aSeparator.length;
                
                if(wordStart < qEnd){
                  // Palavra est√° na pergunta
                  targetSpan = qSpan;
                  localStart = wordStart - qPrefix.length;
                  localEnd = wordEnd - qPrefix.length;
                } else if(wordStart >= aStart){
                  // Palavra est√° na resposta
                  targetSpan = aSpan;
                  localStart = wordStart - aStart;
                  localEnd = wordEnd - aStart;
                }
              } else if(part.type === "card"){
                const titleSpan = items[itemIndex].querySelector('.ctitle');
                const textSpan = items[itemIndex].querySelector('.ctext');
                const titleText = titleSpan ? titleSpan.textContent : "";
                const separator = ". ";
                const titleEnd = titleText.length;
                const textStart = titleEnd + separator.length;
                
                if(wordStart < titleEnd){
                  // Palavra est√° no t√≠tulo
                  targetSpan = titleSpan;
                  localStart = wordStart;
                  localEnd = wordEnd;
                } else if(wordStart >= textStart){
                  // Palavra est√° no texto
                  targetSpan = textSpan;
                  localStart = wordStart - textStart;
                  localEnd = wordEnd - textStart;
                }
              }
              
              if(targetSpan && localStart >= 0){
                const text = targetSpan.textContent;
                if(localStart < text.length){
                  // Salvar conte√∫do original apenas uma vez
                  if(currentHighlightElement !== targetSpan){
                    if(currentHighlightElement){
                      currentHighlightElement.innerHTML = originalContent;
                    }
                    originalContent = targetSpan.innerHTML;
                    currentHighlightElement = targetSpan;
                  }
                  
                  // Construir HTML com highlight
                  const before = text.substring(0, Math.max(0, localStart));
                  const highlighted = text.substring(Math.max(0, localStart), Math.min(text.length, localEnd));
                  const after = text.substring(Math.min(text.length, localEnd));
                  
                  targetSpan.innerHTML = before + '<span class="tts-highlight">' + highlighted + '</span>' + after;
                }
              }
            }
          }
        }
      };
      
      utter.onend = ()=> { 
        clearHighlight();
        if(autoplay && curIdx < playlist.length-1){ 
          curIdx++; 
          speakCurrent(); 
        } else {
          $("#ttsPlay").classList.remove("tts-active");
          ttsPlayFloat.classList.remove("tts-active");
        }
      };
      
      $("#ttsPlay").classList.add("tts-active");
      ttsPlayFloat.classList.add("tts-active");
      $("#ttsPause").classList.remove("tts-active");
      ttsPauseFloat.classList.remove("tts-active");
      window.speechSynthesis.speak(utter);
    }
    $("#ttsPlay").addEventListener("click", ()=> { 
      if(curIdx<0 && playlist.length){curIdx=0;} 
      autoplay = true; 
      ttsAuto.textContent="Autoplay ON"; 
      $("#ttsPlay").classList.add("tts-active");
      ttsPlayFloat.classList.add("tts-active");
      $("#ttsPause").classList.remove("tts-active");
      ttsPauseFloat.classList.remove("tts-active");
      
      if(isPaused) {
        window.speechSynthesis.resume();
        isPaused = false;
      } else {
        speakCurrent();
      }
    });
    $("#ttsPrev").addEventListener("click", ()=> { if(curIdx>0){ curIdx--; isPaused=false; speakCurrent(); } });
    $("#ttsNext").addEventListener("click", ()=> { if(curIdx<playlist.length-1){ curIdx++; isPaused=false; speakCurrent(); } });
    $("#ttsPause").addEventListener("click", ()=> { 
      autoplay=false; 
      ttsAuto.textContent="Autoplay OFF"; 
      $("#ttsPause").classList.add("tts-active");
      ttsPauseFloat.classList.add("tts-active");
      $("#ttsPlay").classList.remove("tts-active");
      ttsPlayFloat.classList.remove("tts-active");
      isPaused = true;
      window.speechSynthesis.pause(); 
    });
    $("#ttsStop").addEventListener("click", ()=> { 
      autoplay=false; 
      ttsAuto.textContent="Autoplay OFF"; 
      $("#ttsPlay").classList.remove("tts-active");
      ttsPlayFloat.classList.remove("tts-active");
      $("#ttsPause").classList.remove("tts-active");
      ttsPauseFloat.classList.remove("tts-active");
      isPaused = false;
      window.speechSynthesis.cancel(); 
      clearHighlight();
      ttsNow.textContent=""; 
      // Voltar ao in√≠cio (t√≠tulo)
      curIdx = 0;
    });
    ttsRateBtn.addEventListener("click", ()=> {
      let next = 1;
      if(rate===1) next=1.5; else if(rate===1.5) next=2; else next=1;
      rate = next; localStorage.setItem(LS_TTS_RATE, String(rate));
      ttsRateBtn.textContent = rate+"x";
      ttsRateFloat.textContent = rate+"x";
      if(window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); speakCurrent(); }
    });

    // -------- Regenera√ß√µes (backend) --------
    async function regenTitle(withPrompt=false){
      outTitle.classList.add("pulse");
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      let promptText = "";
      if(withPrompt){ const txt = await openPrompt("Instru√ß√µes para regerar o t√≠tulo:"); if(txt===null){ outTitle.classList.remove("pulse"); return; } promptText = txt; }
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "title",
        prompt: promptText,
        context: { previous: outTitle.value },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      try {
        const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
        const data = await r.json();
        if(data.title && data.title !== outTitle.value){ pushHistory("title", data.title); }
      } finally { outTitle.classList.remove("pulse"); }
    }
    async function regenDesc(withPrompt=false){
      outDesc.classList.add("pulse");
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      let promptText = "";
      if(withPrompt){ const txt = await openPrompt("Instru√ß√µes para regerar a descri√ß√£o:"); if(txt===null){ outDesc.classList.remove("pulse"); return; } promptText = txt; }
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "description",
        prompt: promptText,
        context: { previous: outDesc.value },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      try {
        const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
        const data = await r.json();
        if(data.description && data.description !== outDesc.value){ pushHistory("description", data.description); }
      } finally { outDesc.classList.remove("pulse"); }
    }
    async function regenFAQ(index, promptText=""){
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "faq_item",
        index,
        prompt: promptText,
        context: { previous: history.faq[index].versions[history.faq[index].vIdx] },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
      const data = await r.json();
      const item = (data.faq && data.faq[0]) ? data.faq[0] : null;
      if(item){
        const line = history.faq[index];
        const curt = line.versions[line.vIdx];
        // SEMPRE adicionar nova vers√£o ao hist√≥rico (mesmo se for igual, para transpar√™ncia)
        line.versions = line.versions.slice(0, line.vIdx+1);
        line.versions.push({q:item.q||curt.q, a:item.a||curt.a});
        line.vIdx = line.versions.length-1;
        renderFAQFromState();
      }
    }
    async function regenCard(index, promptText=""){
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      const body = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        field: "card",
        index,
        prompt: promptText,
        context: { previous: history.cardLines[index].versions[history.cardLines[index].vIdx] },
        options: { llm: llm.value, openai_api_key:(saved.openai||"").trim(), openai_base_url:(saved.openai_base||"").trim(), gemini_api_key:(saved.gemini||"").trim(), gemini_base_url:(saved.gemini_base||"").trim() }
      };
      const r = await fetch("/api/regen",{method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)});
      const data = await r.json();
      const item = (data.cards && data.cards[0]) ? data.cards[0] : null;
      if(item){
        const line = history.cardLines[index];
        const cur = line.versions[line.vIdx];
        // SEMPRE adicionar nova vers√£o ao hist√≥rico (mesmo se for igual, para transpar√™ncia)
        line.versions = line.versions.slice(0, line.vIdx+1);
        line.versions.push({title:item.title||cur.title, text:item.text||cur.text});
        line.vIdx = line.versions.length-1;
        // Reset copy state when regenerating
        line.copiedTitle = false;
        line.copiedText = false;
        buildCurrentCards(); renderCardsFromState(); persistState(); rebuildPlaylist();
      }
    }

    // Copiar
    $("#copyAll").addEventListener("click", ()=> {
      const approvedFAQ = history.faq.filter(f=>f.approved).map(f => {
        const cur = f.versions[f.vIdx]; return `P: ${cur.q}\nR: ${cur.a}`;
      }).join("\n\n");
      const cardsTxt = (history.cards||[]).map(c => `‚Ä¢ ${c.title}: ${c.text}`).join("\n");
      const text = ["T√≠tulo:", outTitle.value, "", "Descri√ß√£o:", outDesc.value, "", "Cards:", cardsTxt, "", "Perguntas frequentes:", approvedFAQ].join("\n");
      navigator.clipboard.writeText(text);
    });
    $("#copyTitle").addEventListener("click", ()=> navigator.clipboard.writeText(outTitle.value));
    $("#copyDesc").addEventListener("click", ()=> {
      const approved = history.faq.filter(f=>f.approved).map(f=> f.versions[f.vIdx] );
      const lines = [outDesc.value];
      if(approved.length){ lines.push("", "Perguntas frequentes"); approved.forEach(x=>{ lines.push(`P: ${x.q}`); lines.push(`R: ${x.a}`); lines.push(""); }); }
      navigator.clipboard.writeText(lines.join("\n"));
    });
    $("#copyDescNoFAQ").addEventListener("click", ()=> navigator.clipboard.writeText(outDesc.value || ""));
    $("#copyFAQApproved").addEventListener("click", ()=> {
      const faqApproved = history.faq.filter(f=>f.approved).map(f => {
        const cur = f.versions[f.vIdx]; return `P: ${cur.q}\nR: ${cur.a}`;
      }).join("\n\n");
      navigator.clipboard.writeText(faqApproved);
    });

    // Gera√ß√£o principal
    async function generate(){
      // Resetar todo o hist√≥rico e interface quando gerar novo conte√∫do
      resetHistory();
      
      statusArea.classList.remove("hidden"); loader.style.display="inline-block"; statusText.textContent="Gerando‚Ä¶";
      demoWarn.classList.add("hidden");
      let saved = {}; try { saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch(e){}
      const req = {
        product_name: productName.value.trim(),
        marketplace: marketplace.value,
        options: {
          llm: llm.value,
          openai_api_key: (saved.openai || "").trim(),
          openai_base_url: (saved.openai_base || "").trim(),
          gemini_api_key: (saved.gemini || "").trim(),
          gemini_base_url: (saved.gemini_base || "").trim(),
          rules: saved.rules || {},
          prompt_template: saved.prompt_template || DEFAULT_PROMPT_TEMPLATE
        }
      };
      try{
        const r = await fetch("/api/generate", {method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(req)});
        const data = await r.json();
        pushHistory("title", data.title || "");
        pushHistory("description", data.description || "");
        renderFAQ(data.faq || []); renderCards(data.cards || []);
        if(data?.sources_used?.mock){
          demoWarn.classList.remove("hidden");
          demoText.textContent = data?.sources_used?.message || "Modo demonstra√ß√£o: cadastre uma chave.";
        }
      } catch(err){
        alert("Erro ao gerar: " + (err?.message || String(err)));
      } finally{
        loader.style.display="none"; setTimeout(()=> statusArea.classList.add("hidden"), 800);
      }
    }

    // Listeners principais
    $("#btnGenerate").addEventListener("click", generate);
    $("#regenTitle").addEventListener("click", ()=> regenTitle(false));
    $("#regenTitlePrompt").addEventListener("click", ()=> regenTitle(true));
    $("#regenDesc").addEventListener("click", ()=> regenDesc(false));
    $("#regenDescPrompt").addEventListener("click", ()=> regenDesc(true));
    titlePrev.addEventListener("click", ()=> navHistory("title",-1));
    titleNext.addEventListener("click", ()=> navHistory("title",+1));
    descPrev.addEventListener("click", ()=> navHistory("description",-1));
    descNext.addEventListener("click", ()=> navHistory("description",+1));

    restoreState();
  </script>
</body>
</html>
